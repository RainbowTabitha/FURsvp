{% extends 'events/base.html' %}
{% load users_extras %}
{% load widget_tweaks %}
{% block title %}Profile - FURsvp{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="container py-3">
    <nav class="modern-breadcrumbs">
        <a href="{% url 'home' %}">
            <span class="material-icons">home</span>
            Home
        </a>
        <span class="breadcrumb-chevron">â€º</span>
        <span class="breadcrumb-current">
            <span class="material-icons">person</span>
            Profile
        </span>
    </nav>
</div>

<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <h1>
            <i class="material-icons align-middle me-2">person</i>
            Profile Settings
        </h1>
        <p>Manage your account settings and preferences</p>
    </div>

    <!-- Navigation -->
    <div class="profile-nav">
        <ul class="nav nav-pills justify-content-center" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                    <i class="material-icons align-middle me-2">settings</i>
                    General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab" aria-controls="password" aria-selected="false">
                    <i class="material-icons align-middle me-2">lock</i>
                    Password
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="twofa-tab" data-bs-toggle="tab" data-bs-target="#twofa" type="button" role="tab" aria-controls="twofa" aria-selected="false">
                    <i class="material-icons align-middle me-2">security</i>
                    2FA
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab" aria-controls="notifications" aria-selected="false">
                    <i class="material-icons align-middle me-2">notifications</i>
                    Notifications
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="delete-tab" data-bs-toggle="tab" data-bs-target="#delete" type="button" role="tab" aria-controls="delete" aria-selected="false">
                    <i class="material-icons align-middle me-2">delete_forever</i>
                    Delete Account
                </button>
            </li>
        </ul>
    </div>

    <div class="tab-content">
        <!-- General Settings Tab -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3>
                        <i class="material-icons align-middle me-2">person</i>
                        Profile Information
                    </h3>
                    <p>Update your personal information and profile picture</p>
                </div>
                
                <div class="profile-avatar-section">
                    <div class="profile-avatar-container">
                        {% if profile.profile_picture_base64 %}
                        <img src="{{ profile.profile_picture_base64 }}" alt="{{ profile.get_display_name }}" class="profile-avatar">
                        {% else %}
                        <div class="profile-avatar-placeholder" style="background-color: {{ profile.get_avatar_color }};">
                            {{ profile.get_initials }}
                        </div>
                        {% endif %}
                        <button type="button" class="profile-avatar-edit-btn" data-bs-toggle="modal" data-bs-target="#profilePictureModal">
                            <i class="material-icons">edit</i>
                        </button>
                    </div>
                    <div class="profile-user-info">
                        <h4>{{ profile.get_display_name }}{% verified_checkmark user %}</h4>
                        <p class="username">@{{ user.username }}</p>
                    </div>
                </div>

                <form method="post" class="profile-form" id="main-profile-form" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="submit_profile_changes" value="1">

                    <div class="form-group">
                        <label for="{{ profile_form.display_name.id_for_label }}" class="form-label">
                            <i class="material-icons align-middle me-2">badge</i>
                            Display Name
                        </label>
                        {{ profile_form.display_name }}
                        {% if profile_form.display_name.help_text %}
                        <div class="form-text">{{ profile_form.display_name.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ profile_form.email.id_for_label }}" class="form-label">
                            <i class="material-icons align-middle me-2">email</i>
                            Email Address
                        </label>
                        {{ profile_form.email }}
                        {% if profile_form.email.help_text %}
                        <div class="form-text">{{ profile_form.email.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ profile_form.discord_username.id_for_label }}" class="form-label">
                            <i class="material-icons align-middle me-2">chat</i>
                            Discord Username
                        </label>
                        {{ profile_form.discord_username }}
                        {% if profile_form.discord_username.help_text %}
                        <div class="form-text">{{ profile_form.discord_username.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ profile_form.telegram_username.id_for_label }}" class="form-label">
                            <i class="material-icons align-middle me-2">send</i>
                            Telegram Username
                        </label>
                        {{ profile_form.telegram_username }}
                        {% if profile_form.telegram_username.help_text %}
                        <div class="form-text">{{ profile_form.telegram_username.help_text }}</div>
                        {% endif %}
                    </div>

                    {{ profile_form.profile_picture_base64 }}

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary-admin" id="main-profile-save-button">
                            <i class="material-icons">save</i>
                            Save Changes
                        </button>
                    </div>
                </form>

                {% if telegram_login_enabled and user.profile.telegram_username %}
                <div class="telegram-section">
                    <div class="telegram-card">
                        <h5>
                            <i class="material-icons align-middle me-2">send</i>
                            Telegram Account
                        </h5>
                        
                        {% if user.profile.telegram_id and user.profile.telegram_username %}
                        <div class="telegram-linked">
                            <div class="telegram-info">
                                <p class="telegram-status">
                                    <i class="material-icons">check_circle</i>
                                    Account Linked
                                </p>
                                <p class="telegram-details">
                                    Telegram ID: {{ user.profile.telegram_id }}<br>
                                    Username: @{{ user.profile.telegram_username }}
                                </p>
                            </div>
                            <button type="button" class="btn btn-outline-danger" id="unlink-telegram-btn">
                                <i class="material-icons">link_off</i>
                                Unlink
                            </button>
                        </div>
                        {% else %}
                        <div class="telegram-unlinked">
                            <p>
                                <i class="material-icons">link_off</i>
                                No Telegram account linked
                            </p>
                            <div id="telegram-login-widget"></div>
                            <script async src="https://telegram.org/js/telegram-widget.js?22"
                                data-telegram-login="{{ telegram_bot_username }}"
                                data-size="large"
                                data-userpic="true"
                                data-auth-url="{% url 'link_telegram_account' %}"></script>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Password Tab -->
        <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3>
                        <i class="material-icons align-middle me-2">lock</i>
                        Change Password
                    </h3>
                    <p>Update your account password</p>
                </div>
                
                <form method="post" action="{% url 'profile' %}" class="profile-form">
                    {% csrf_token %}
                    <input type="hidden" name="submit_password_changes" value="1">
                    
                    {% for field in password_change_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            <i class="material-icons align-middle me-2">lock</i>
                            {{ field.label }}
                        </label>
                        {{ field|add_class:'form-control' }}
                        {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                        {% endif %}
                        {% if field.errors %}
                        <div class="invalid-feedback d-block">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary-admin">
                            <i class="material-icons">save</i>
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2FA Tab -->
        <div class="tab-pane fade" id="twofa" role="tabpanel" aria-labelledby="twofa-tab">
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3>
                        <i class="material-icons align-middle me-2">security</i>
                        Two-Factor Authentication
                    </h3>
                    <p>Secure your account with 2FA</p>
                </div>
                
                <div class="twofa-content">
                    {% if device %}
                    <div class="twofa-enabled">
                        <div class="twofa-status">
                            <i class="material-icons">check_circle</i>
                            <h4>2FA is enabled</h4>
                            <p>Your account is protected with two-factor authentication.</p>
                        </div>
                        <form method="post" action="{% url 'twofa_disable' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                <i class="material-icons">security</i>
                                Disable 2FA
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="twofa-disabled">
                        <div class="twofa-status">
                            <i class="material-icons">warning</i>
                            <h4>2FA is not enabled</h4>
                            <p>Enable two-factor authentication to add an extra layer of security to your account.</p>
                        </div>
                        <a href="{% url 'twofa_enable' %}" class="btn btn-primary-admin">
                            <i class="material-icons">security</i>
                            Enable 2FA
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3>
                        <i class="material-icons align-middle me-2">notifications</i>
                        Notification Settings
                    </h3>
                    <p>Manage your notification preferences and email settings</p>
                </div>
                
                <form method="post" class="profile-form" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="submit_notification_changes" value="1">
                    
                    <div class="form-group">
                        <div class="notification-setting">
                            <div class="setting-info">
                                <label for="id_email_notifications" class="form-label">
                                    <i class="material-icons align-middle me-2">email</i>
                                    Email Notifications
                                </label>
                                <p class="setting-description">Receive email notifications when you get new notifications on FURsvp</p>
                            </div>
                            <div class="setting-toggle">
                                <div class="form-check form-switch">
                                    {{ profile_form.email_notifications }}
                                    <label class="form-check-label" for="id_email_notifications">
                                        <span class="toggle-label">{% if profile_form.email_notifications.value %}Enabled{% else %}Disabled{% endif %}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary-admin">
                            <i class="material-icons">save</i>
                            Save Notification Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Account Tab -->
        <div class="tab-pane fade" id="delete" role="tabpanel" aria-labelledby="delete-tab">
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3>
                        <i class="material-icons align-middle me-2">delete_forever</i>
                        Delete Account
                    </h3>
                    <p>Permanently delete your account and all associated data</p>
                </div>
                
                <div class="delete-account-content">
                    <div class="delete-warning">
                        <i class="material-icons">warning</i>
                        <h4>This action cannot be undone</h4>
                        <p>Deleting your account will permanently remove all your data, including:</p>
                        <ul>
                            <li>Your profile information</li>
                            <li>All event RSVPs</li>
                            <li>Group memberships</li>
                            <li>Account settings</li>
                        </ul>
                    </div>
                    
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                        <i class="material-icons">delete_forever</i>
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Picture Modal -->
<div class="modal fade" id="profilePictureModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="material-icons">photo_camera</i>
                    Update Profile Picture
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="profile-picture-form">
                    {% csrf_token %}
                    <input type="hidden" name="profile_picture_base64" id="profile-picture-base64">
                    <input type="hidden" name="submit_pfp_changes" value="1">
                    
                    <div class="form-group">
                        <label for="profile-picture-input" class="form-label">Choose an image</label>
                        <input type="file" class="form-control" id="profile-picture-input" accept="image/*">
                    </div>
                    
                    <div class="form-group d-none" id="image-cropper-container">
                        <img id="image-to-crop" src="" alt="Image to Crop" style="max-width: 100%; display: block;">
                    </div>

                    {% if profile.profile_picture_base64 %}
                    <div class="form-group" id="remove-pfp-button-container">
                        <button type="button" class="btn btn-outline-danger w-100" id="remove-pfp-button">
                            <i class="material-icons">delete</i>
                            Remove Current Profile Picture
                        </button>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-admin" id="crop-and-save-button">
                    <i class="material-icons">save</i>
                    Crop and Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="delete-account-form" onsubmit="return false;">
                {% csrf_token %}
                <input type="hidden" name="delete_account" value="1">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAccountModalLabel">
                        <i class="material-icons">warning</i>
                        Confirm Account Deletion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <p>This action cannot be undone. To confirm, please solve the following equation:</p>
                    <div class="form-group">
                        <span id="math-equation" class="math-equation"></span>
                        <input type="number" class="form-control mt-2" id="math-answer" placeholder="Your answer" required>
                        <div class="invalid-feedback" id="math-feedback">Incorrect answer. Please try again.</div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="open-final-delete-btn" disabled>
                        <i class="material-icons">delete_forever</i>
                        Delete My Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Final Confirmation Modal -->
<div class="modal fade" id="finalDeleteModal" tabindex="-1" aria-labelledby="finalDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" id="final-delete-form">
                {% csrf_token %}
                <input type="hidden" name="delete_account" value="1">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="finalDeleteModalLabel">
                        <i class="material-icons">delete_forever</i>
                        Final Confirmation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>This is your last chance to back out.</strong> If you proceed, your account will be deleted forever.
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="final-delete-btn">
                        <i class="material-icons">delete_forever</i>
                        Delete for Real
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="telegram-redirect-feedback" style="display:none;text-align:center;margin:2em 0;">
    <div class="spinner-border text-info" role="status" style="width:3rem;height:3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div style="margin-top:1em;font-weight:bold;">Linking your Telegram account, please wait...</div>
</div>

<noscript>
    <div class="alert alert-warning text-center mt-3">JavaScript is required for Telegram login to work.</div>
</noscript>

<script>
    // Show feedback if redirected from Telegram
    if (window.location.search.includes('auth_date') && window.location.pathname.includes('link')) {
        var feedback = document.getElementById('telegram-redirect-feedback');
        if (feedback) feedback.style.display = 'block';
    }
</script>

{% endblock %}

{% block extra_css %}
<style>
/* Profile Container */
.profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 0;
}

/* Profile Header */
.profile-header {
    text-align: center;
    margin-bottom: 2rem;
}

.profile-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

.profile-header p {
    color: #6b7280;
    font-size: 1.125rem;
    margin: 0;
}

/* Profile Navigation */
.profile-nav {
    margin-bottom: 2rem;
}

.profile-nav .nav-pills {
    gap: 0.5rem;
}

.profile-nav .nav-link {
    border: none;
    border-radius: 0.75rem;
    background: #f8fafc;
    color: #374151;
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.profile-nav .nav-link:hover {
    background: #e5e7eb;
    color: #1f2937;
    transform: translateY(-1px);
}

.profile-nav .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

/* Profile Card */
.profile-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.profile-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
}

.profile-card-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.profile-card-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1rem;
}

/* Profile Avatar Section */
.profile-avatar-section {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    border-bottom: 1px solid #e5e7eb;
}

.profile-avatar-container {
    position: relative;
    flex-shrink: 0;
}

.profile-avatar,
.profile-avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.profile-avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2.5rem;
    font-weight: 700;
}

.profile-avatar-edit-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.profile-avatar-edit-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.profile-user-info h4 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 0.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.profile-user-info .username {
    color: #6b7280;
    font-size: 1rem;
    margin: 0;
}

/* Profile Form */
.profile-form {
    padding: 2rem;
    max-width: 100%;
}

/* Password form specific styling */
#password .profile-form {
    padding: 2rem;
    width: 100%;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-control {
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    background: white;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-text {
    color: #6b7280;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.form-actions {
    margin-top: 2rem;
    text-align: center;
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
}

/* Buttons */
.btn {
    border-radius: 0.75rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary-admin {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary-admin:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
}

.btn-outline-danger {
    border: 2px solid #ef4444;
    color: #ef4444;
    background: transparent;
}

.btn-outline-danger:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-1px);
}

/* Telegram Section */
.telegram-section {
    padding: 2rem;
    border-top: 1px solid #e5e7eb;
}

.telegram-card {
    background: #f8fafc;
    border-radius: 0.75rem;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
}

.telegram-card h5 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #374151;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.telegram-linked {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.telegram-status {
    font-weight: 600;
    color: #059669;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.telegram-details {
    color: #6b7280;
    font-size: 0.875rem;
    margin: 0;
}

.telegram-unlinked {
    text-align: center;
}

.telegram-unlinked p {
    color: #6b7280;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* 2FA Section */
.twofa-content {
    padding: 2rem;
}

.twofa-enabled,
.twofa-disabled {
    text-align: center;
}

.twofa-status {
    margin-bottom: 2rem;
}

.twofa-status i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.twofa-enabled .twofa-status i {
    color: #059669;
}

.twofa-disabled .twofa-status i {
    color: #f59e0b;
}

.twofa-status h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
}

.twofa-status p {
    color: #6b7280;
    margin: 0;
}

/* Delete Account Section */
.delete-account-content {
    padding: 2rem;
}

.delete-warning {
    text-align: center;
    margin-bottom: 2rem;
}

.delete-warning i {
    font-size: 3rem;
    color: #ef4444;
    margin-bottom: 1rem;
}

.delete-warning h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 1rem 0;
}

.delete-warning p {
    color: #6b7280;
    margin: 0 0 1rem 0;
}

.delete-warning ul {
    text-align: left;
    color: #6b7280;
    margin: 0;
    padding-left: 1.5rem;
}

.delete-warning li {
    margin-bottom: 0.25rem;
}

/* Math Equation */
.math-equation {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    display: block;
    text-align: center;
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .profile-container {
        padding: 1rem;
    }
    
    .profile-header h1 {
        font-size: 2rem;
    }
    
    .profile-nav .nav-pills {
        flex-direction: column;
    }
    
    .profile-avatar-section {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .profile-avatar,
    .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
    }
    
    .telegram-linked {
        flex-direction: column;
        text-align: center;
    }
}

/* Notification Settings Styling */
.notification-setting {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
}

.setting-info {
    flex: 1;
}

.setting-info .form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
    font-size: 1rem;
    text-transform: none;
    letter-spacing: normal;
}

.setting-description {
    color: #6b7280;
    font-size: 0.875rem;
    margin: 0;
}

.setting-toggle {
    flex-shrink: 0;
    margin-left: 1rem;
}

.form-check.form-switch {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-check-input {
    width: 3rem;
    height: 1.5rem;
    margin: 0;
    cursor: pointer;
}

.form-check-input:checked {
    background-color: #8b5cf6;
    border-color: #8b5cf6;
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
}

.form-check-label {
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    margin: 0;
}

.toggle-label {
    font-size: 0.875rem;
    color: #6b7280;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile picture handling
    const profilePictureInput = document.getElementById('profile-picture-input');
    const imageToCrop = document.getElementById('image-to-crop');
    const imageCropperContainer = document.getElementById('image-cropper-container');
    const profilePictureBase64Input = document.getElementById('profile-picture-base64');
    const cropAndSaveButton = document.getElementById('crop-and-save-button');
    const removePfpButtonContainer = document.getElementById('remove-pfp-button-container');
    const removePfpButton = document.getElementById('remove-pfp-button');
    let cropper;

    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    imageToCrop.src = event.target.result;
                    if (cropper) {
                        cropper.destroy();
                    }
                    imageCropperContainer.classList.remove('d-none');
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true,
                        dragMode: 'move',
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
                    });
                    if (removePfpButtonContainer) {
                        removePfpButtonContainer.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                if (cropper) {
                    cropper.destroy();
                }
                imageCropperContainer.classList.add('d-none');
                if (removePfpButtonContainer && profilePictureBase64Input.value) {
                    removePfpButtonContainer.style.display = 'block';
                }
            }
        });
    }

    if (cropAndSaveButton) {
        cropAndSaveButton.addEventListener('click', function() {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 150,
                    height: 150
                });
                profilePictureBase64Input.value = croppedCanvas.toDataURL('image/jpeg');
                document.getElementById('profile-picture-form').submit();
            }
        });
    }

    if (removePfpButton) {
        removePfpButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to remove your profile picture?')) {
                profilePictureBase64Input.value = '';
                document.getElementById('profile-picture-form').submit();
            }
        });
    }

    // Main profile form submission
    const mainProfileSaveButton = document.getElementById('main-profile-save-button');
    const mainProfileForm = document.getElementById('main-profile-form');

    if (mainProfileSaveButton && mainProfileForm) {
        mainProfileSaveButton.addEventListener('click', function() {
            mainProfileForm.submit();
        });
    }

    // Tab persistence
    const profileTabs = document.getElementById('profileTabs');
    if (profileTabs) {
        const lastProfileTab = localStorage.getItem('lastProfileTab');
        if (lastProfileTab) {
            const lastTabButton = document.querySelector(`#profileTabs button[data-bs-target="${lastProfileTab}"]`);
            if (lastTabButton) {
                new bootstrap.Tab(lastTabButton).show();
            }
        }

        profileTabs.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(tabBtn) {
            tabBtn.addEventListener('shown.bs.tab', function(e) {
                localStorage.setItem('lastProfileTab', e.target.getAttribute('data-bs-target'));
            });
        });
    }

    // Delete account math equation
    function generateEquation() {
        const a = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 10) + 1;
        const op = Math.random() > 0.5 ? '+' : '-';
        const answer = op === '+' ? a + b : a - b;
        return {
            text: `${a} ${op} ${b} = ?`,
            answer
        };
    }

    let equation = null;
    const deleteModal = document.getElementById('deleteAccountModal');
    const equationSpan = document.getElementById('math-equation');
    const answerInput = document.getElementById('math-answer');
    const openFinalBtn = document.getElementById('open-final-delete-btn');
    const feedback = document.getElementById('math-feedback');
    const finalDeleteModal = document.getElementById('finalDeleteModal');

    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function() {
            equation = generateEquation();
            equationSpan.textContent = equation.text;
            answerInput.value = '';
            openFinalBtn.disabled = true;
            feedback.style.display = 'none';
        });

        answerInput.addEventListener('input', function() {
            if (parseInt(answerInput.value, 10) === equation.answer) {
                openFinalBtn.disabled = false;
                feedback.style.display = 'none';
            } else {
                openFinalBtn.disabled = true;
                if (answerInput.value !== '') {
                    feedback.style.display = 'block';
                } else {
                    feedback.style.display = 'none';
                }
            }
        });

        openFinalBtn.addEventListener('click', function() {
            const bsModal = bootstrap.Modal.getInstance(deleteModal);
            bsModal.hide();
            const finalModal = new bootstrap.Modal(finalDeleteModal);
            finalModal.show();
        });
    }

    // Notification toggle functionality
    const emailNotificationsCheckbox = document.getElementById('id_email_notifications');
    const toggleLabel = document.querySelector('.toggle-label');
    
    if (emailNotificationsCheckbox && toggleLabel) {
        // Update label on page load
        toggleLabel.textContent = emailNotificationsCheckbox.checked ? 'Enabled' : 'Disabled';
        
        // Update label when checkbox changes
        emailNotificationsCheckbox.addEventListener('change', function() {
            toggleLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
        });
    }
});
</script>
{% endblock %}