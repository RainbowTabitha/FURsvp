{% extends 'events/base.html' %}
{% block title %}Home - FURsvp{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="modern-breadcrumbs">
        <span class="breadcrumb-current">
            <i class="material-icons me-1">home</i> Home
        </span>
    </div>
</nav>

<!-- Hero Section -->
<section class="hero-section mb-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="hero-card text-center">
                    <div class="hero-content">
                        <div class="hero-badge mb-4">
                            <span class="material-icons">pets</span>
                            <span>FURsvp - Furry Event Organizer</span>
                        </div>
                        <p class="hero-description mb-5">
                            The ultimate platform for furry event organizers and attendees. 
                            Create events, manage RSVPs, and discover amazing furry gatherings 
                            in your area. Free, open-source, and built for the fandom.
                        </p>
                        <div class="hero-stats mb-5">
                            <div class="row justify-content-center">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ events_count }}</div>
                                        <div class="stat-label">Events Created</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ groups_count }}</div>
                                        <div class="stat-label">Groups</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ users_count }}</div>
                                        <div class="stat-label">Members</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ rsvps_count }}</div>
                                        <div class="stat-label">RSVPs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hero-actions">
                            {% if user.is_authenticated and user.group_roles.all %}
                            <a href="{% url 'create_event' %}" class="btn btn-primary btn-lg me-3">
                                <span class="material-icons me-2">add_circle</span> Create Event
                            </a>
                            {% elif user.is_authenticated %}
                            <a href="{% url 'groups_list' %}" class="btn btn-primary btn-lg me-3">
                                <span class="material-icons me-2">event</span> View Events
                            </a>
                            {% else %}
                            <a href="{% url 'register' %}" class="btn btn-primary btn-lg me-3">
                                <span class="material-icons me-2">person_add</span> Get Started
                            </a>
                            <a href="{% url 'login' %}" class="btn btn-outline-primary btn-lg">
                                <span class="material-icons me-2">login</span> Sign In
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section mb-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon mb-3">
                        <span class="material-icons">event_available</span>
                    </div>
                    <h3 class="feature-title">Easy Event Management</h3>
                    <p class="feature-description">
                        Create and manage events with powerful RSVP tools, 
                        custom questions, and real-time attendee tracking.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon mb-3">
                        <span class="material-icons">groups</span>
                    </div>
                    <h3 class="feature-title">Community Focused</h3>
                    <p class="feature-description">
                        Built specifically for the Furry Fandom with 
                        features that matter to event organizers and attendees.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="feature-card text-center">
                    <div class="feature-icon mb-3">
                        <span class="material-icons">security</span>
                    </div>
                    <h3 class="feature-title">Privacy First</h3>
                    <p class="feature-description">
                        Your data stays yours. Open-source, transparent, 
                        and designed with privacy in mind.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Events Section -->
<section class="events-section">
    <div class="container">
        <div class="events-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="section-title d-flex align-items-center">
                        <span class="material-icons me-3">event</span> 
                        RSVPed Events
                    </h2>
                </div>
                <div class="col-md-6 text-md-end">
                                    <a href="{% url 'event_index' %}" class="btn btn-outline-primary">
                    <span class="material-icons me-2">event</span> Browse All Events
                </a>
                </div>
            </div>
        </div>

        <div class="card shadow-custom">
            <div class="card-body p-4">
                <!-- Search Form -->
                <div class="search-section mb-4">
                    <form method="get" id="eventSearchFilterForm">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0">
                                <span class="material-icons text-muted">search</span>
                            </span>
                            <input type="text" id="eventSearchInput" name="search" class="form-control border-start-0" 
                                   placeholder="Search events by title, description, city, or group..." 
                                   value="{{ request.GET.search|default:''|escapejs }}">
                            <input type="hidden" name="sort" value="{{ current_sort|default:''|escapejs }}">
                            <input type="hidden" name="order" value="{{ current_order|default:''|escapejs }}">
                            <input type="hidden" name="adult" value="{{ filter_adult|default:''|escapejs }}">
                            <input type="hidden" name="view" value="{{ view_type|default:''|escapejs }}">
                            <button type="submit" class="btn btn-primary">
                                Search
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Filter Controls -->
                <div class="filter-controls mb-4">
                    <div class="row align-items-center">
                        <div class="col-lg-8 mb-3 mb-lg-0">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="btn-group" role="group">
                                    <a href="#" data-sort="date" data-order="{{ current_order|default:'asc'|escapejs }}"
                                       class="btn {% if current_sort == 'date' %}btn-primary{% else %}btn-outline-primary{% endif %} sort-btn">
                                        <span class="material-icons me-1">calendar_today</span> Date
                                    </a>
                                    <a href="#" data-sort="group" data-order="{{ current_order|default:'asc'|escapejs }}"
                                       class="btn {% if current_sort == 'group' %}btn-primary{% else %}btn-outline-primary{% endif %} sort-btn">
                                        <span class="material-icons me-1">group</span> Group
                                    </a>
                                    <a href="#" data-sort="title" data-order="{{ current_order|default:'asc'|escapejs }}"
                                       class="btn {% if current_sort == 'title' %}btn-primary{% else %}btn-outline-primary{% endif %} sort-btn">
                                        <span class="material-icons me-1">title</span> Title
                                    </a>
                                    <a href="#" data-sort="rsvps" data-order="{{ current_order|default:'asc'|escapejs }}"
                                       class="btn {% if current_sort == 'rsvps' %}btn-primary{% else %}btn-outline-primary{% endif %} sort-btn">
                                        <span class="material-icons me-1">people</span> RSVPs
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                                <button type="button" id="toggleAdultEvents" class="btn btn-success" style="display: none;">
                                    <span class="material-icons me-1">visibility</span> Show 18+/21+
                                </button>
                                <div class="btn-group" role="group">
                                    <a href="#" id="orderToggleBtn" data-sort="{{ current_sort|default:'date'|escapejs }}" 
                                       data-order="{% if current_order == 'asc' %}desc{% else %}asc{% endif %}"
                                       class="btn btn-outline-primary order-toggle-btn" title="Toggle Order">
                                        <span class="material-icons">{% if current_order == 'desc' %}arrow_downward{% else %}arrow_upward{% endif %}</span>
                                    </a>
                                    <button type="button" class="btn btn-outline-primary" id="viewToggle" title="Toggle View">
                                        <span class="material-icons">grid_view</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events List -->
                {% include 'events/events_list_partial.html' %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    /* Hero Section */
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 4rem 0;
        border-radius: var(--border-radius-xl);
        margin: 2rem 0;
        position: relative;
        overflow: hidden;
    }

    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .hero-card {
        position: relative;
        z-index: 1;
    }

    .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius-lg);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
    }

    .hero-description {
        font-size: 1.25rem;
        color: rgba(255, 255, 255, 0.9);
        max-width: 600px;
        margin: 0 auto;
    }

    .hero-stats {
        margin: 3rem 0;
    }

    .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }

    .stat-subtitle {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
        font-weight: 400;
        margin-top: 0.25rem;
    }

    .hero-actions {
        margin-top: 2rem;
    }

    /* Features Section */
    .features-section {
        padding: 2rem 0;
    }

    .feature-card {
        background: var(--bg-secondary);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
        height: 100%;
    }

    .feature-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-lg);
    }

    .feature-icon {
        width: 80px;
        height: 80px;
        background: var(--primary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    .feature-icon .material-icons {
        font-size: 2.5rem;
        color: white;
    }

    .feature-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    .feature-description {
        color: var(--text-secondary);
        line-height: 1.6;
    }

    /* Events Section */
    .events-section {
        padding: 2rem 0;
    }

    .section-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .search-section .input-group {
        box-shadow: var(--shadow-sm);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .search-section .input-group-text {
        border: 2px solid #e2e8f0;
        border-right: none;
    }

    .search-section .form-control {
        border: 2px solid #e2e8f0;
        border-left: none;
    }

    .filter-controls {
        background: var(--bg-primary);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border: 1px solid #e2e8f0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.5rem;
        }
        
        .hero-description {
            font-size: 1.1rem;
        }
        
        .stat-item {
            padding: 1rem;
        }
        
        .stat-number {
            font-size: 1.5rem;
        }
        
        .feature-card {
            padding: 1.5rem;
        }
        
        .section-title {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const viewToggle = document.getElementById('viewToggle');
        const eventsGrid = document.getElementById('eventsGrid');
        const eventsList = document.getElementById('eventsList');
        const toggleIcon = viewToggle.querySelector('.material-icons');
        const toggleAdult = document.getElementById('toggleAdultEvents');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const orderToggleBtn = document.getElementById('orderToggleBtn');

        // Set initial state
        let isListView = localStorage.getItem('eventViewPreference') === 'list';
        let showAdult = false;
        let currentSort = '{{ current_sort|default:"date"|escapejs }}';
        let currentOrder = '{{ current_order|default:"asc"|escapejs }}';

        // Function to update the UI based on events data
        function updateEventDisplay(eventsHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = eventsHtml;
            const newEventsGrid = tempDiv.querySelector('#eventsGrid');
            const newEventsList = tempDiv.querySelector('#eventsList');
            const newLoadingSpinner = tempDiv.querySelector('#loadingSpinner');

            if (newEventsGrid && eventsGrid) {
                eventsGrid.innerHTML = newEventsGrid.innerHTML;
            }
            if (newEventsList && eventsList) {
                eventsList.innerHTML = newEventsList.innerHTML;
            }

            // Ensure the correct view is displayed after update
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
            }

            if (newLoadingSpinner && loadingSpinner) {
                loadingSpinner.style.display = newLoadingSpinner.style.display;
            }
        }

        // Function to fetch and update events
        async function fetchEvents(sort, order, adult, page = 1) {
            loadingSpinner.style.display = 'block';
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sort);
                url.searchParams.set('order', order);
                url.searchParams.set('adult', adult);
                url.searchParams.set('page', page);

                currentSort = sort;
                currentOrder = order;

                history.pushState({ sort: sort, order: order, adult: adult, page: page }, '', url.toString());

                const response = await fetch(url.toString());
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newEventsGridHtml = doc.querySelector('#eventsGrid').innerHTML;
                const newEventsListHtml = doc.querySelector('#eventsList').innerHTML;
                const newLoadingSpinnerHtml = doc.querySelector('#loadingSpinner').innerHTML;

                eventsGrid.innerHTML = newEventsGridHtml;
                eventsList.innerHTML = newEventsListHtml;
                loadingSpinner.innerHTML = newLoadingSpinnerHtml;

                // Update pagination
                const newPagination = doc.querySelector('.pagination');
                const existingPagination = document.querySelector('.pagination');
                if (newPagination && existingPagination) {
                    existingPagination.innerHTML = newPagination.innerHTML;
                } else if (newPagination && !existingPagination) {
                    const eventsContainer = document.querySelector('.card-body');
                    if (eventsContainer) {
                        eventsContainer.appendChild(newPagination.cloneNode(true));
                    }
                } else if (!newPagination && existingPagination) {
                    existingPagination.remove();
                }

                // Apply current view preference after update
                if (isListView) {
                    eventsGrid.style.display = 'none';
                    eventsList.style.display = 'block';
                } else {
                    eventsGrid.style.display = 'flex';
                    eventsList.style.display = 'none';
                }

                // Update active state for sort buttons
                sortButtons.forEach(button => {
                    button.classList.remove('btn-primary', 'btn-outline-primary');
                    if (button.dataset.sort === currentSort) {
                        button.classList.add('btn-primary');
                    } else {
                        button.classList.add('btn-outline-primary');
                    }
                });

                // Update the order toggle button
                orderToggleBtn.dataset.order = currentOrder;
                const orderIcon = orderToggleBtn.querySelector('.material-icons');
                if (orderIcon) {
                    orderIcon.textContent = currentOrder === 'desc' ? 'arrow_downward' : 'arrow_upward';
                }

                attachPaginationListeners();

            } catch (error) {
                console.error('Error fetching events:', error);
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // Function to attach pagination event listeners
        function attachPaginationListeners() {
            const paginationLinks = document.querySelectorAll('.page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    if (href) {
                        const url = new URL(href, window.location.origin);
                        const page = url.searchParams.get('page') || 1;
                        const sort = url.searchParams.get('sort') || currentSort;
                        const order = url.searchParams.get('order') || currentOrder;
                        const adult = url.searchParams.get('adult') || (showAdult ? 'true' : 'false');
                        
                        fetchEvents(sort, order, adult === 'true', page);
                    }
                });
            });
        }

        // Event Listeners for Sorting Buttons
        sortButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const sortType = this.dataset.sort;
                const newOrder = (sortType === currentSort) ? (currentOrder === 'asc' ? 'desc' : 'asc') : currentOrder;
                fetchEvents(sortType, newOrder, showAdult, 1);
            });
        });

        // Event Listener for Order Toggle Button
        orderToggleBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            currentOrder = newOrder;
            this.dataset.order = newOrder;
            fetchEvents(currentSort, newOrder, showAdult, 1);
        });

        // Toggle Adult Events
        function toggleAdultEvents() {
            showAdult = !showAdult;
            localStorage.setItem('showAdultEvents', showAdult);
            if (showAdult) {
                toggleAdult.textContent = 'Hide 18+/21+';
                toggleAdult.classList.remove('btn-success');
                toggleAdult.classList.add('btn-danger');
            } else {
                toggleAdult.textContent = 'Show 18+/21+';
                toggleAdult.classList.remove('btn-danger');
                toggleAdult.classList.add('btn-success');
            }
            fetchEvents(currentSort, currentOrder, showAdult, 1);
        }

        toggleAdult.addEventListener('click', toggleAdultEvents);

        // View Toggle (Grid/List)
        function toggleView() {
            isListView = !isListView;
            localStorage.setItem('eventViewPreference', isListView ? 'list' : 'grid');
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
                toggleIcon.textContent = 'view_list';
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
                toggleIcon.textContent = 'grid_view';
            }
        }

        viewToggle.addEventListener('click', toggleView);

        // Initial display setup
        if (isListView) {
            eventsGrid.style.display = 'none';
            eventsList.style.display = 'block';
            toggleIcon.textContent = 'view_list';
        } else {
            eventsGrid.style.display = 'flex';
            eventsList.style.display = 'none';
            toggleIcon.textContent = 'grid_view';
        }

        // Initial color and text setup
        if (showAdult) {
            toggleAdult.textContent = 'Hide 18+/21+';
            toggleAdult.classList.remove('btn-success');
            toggleAdult.classList.add('btn-danger');
        } else {
            toggleAdult.textContent = 'Show 18+/21+';
            toggleAdult.classList.remove('btn-danger');
            toggleAdult.classList.add('btn-success');
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const state = event.state;
            if (state) {
                currentSort = state.sort || 'date';
                currentOrder = state.order || 'asc';
                showAdult = state.adult !== false;
                const page = state.page || 1;
                fetchEvents(currentSort, currentOrder, showAdult, page);
            } else {
                fetchEvents('date', 'asc', true, 1);
            }
        });

        // Initial pagination listener attachment
        attachPaginationListeners();
    });
</script>
{% endblock %}