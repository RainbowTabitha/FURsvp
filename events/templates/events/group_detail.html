{% extends 'events/base.html' %}
{% load users_extras %}
{% load static %}
{% load tz %}

{% block title %}{{ group.name }} - FURsvp{% endblock %}

{% block extra_css %}
<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<!-- Quill.js CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
/* Event Filters */
.event-filters {
    background: #f8fafc;
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
    margin-bottom: 2rem;
}

.filter-label-modern {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-input-modern {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
    color: #2d3748;
}

.search-input-modern:focus {
    outline: none;
    border-color: #4f46e5;
    background: white;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.filter-btn-modern {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    color: #374151;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.filter-btn-modern:hover {
    border-color: #4f46e5;
    color: #4f46e5;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
}

.filter-btn-modern.active {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
}

.filter-btn-modern.active:hover {
    background: linear-gradient(135deg, #4338ca 0%, #6d28d9 50%, #db2777 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
}

/* Hidden events */
.event-card.hidden {
    display: none;
}

/* Telegram post clickable styling */
.telegram-post {
    cursor: pointer;
    transition: all 0.2s ease;
}

.telegram-post:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Facebook-style Group Page */
.group-page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0;
}

/* Use site's rounded edges */
.group-card,
.sidebar-card,
.leader-card,
.event-card,
.group-action-btn,
.leader-btn,
.toggle-btn,
.btn {
    border-radius: var(--border-radius);
}

.group-card-header,
.sidebar-card-header {
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.group-logo,
.group-logo-placeholder,
.leader-avatar,
.leader-initials {
    border-radius: 50%;
}

.group-action-btn {
    border-radius: 2rem;
}

.toggle-btn {
    border-radius: 0.75rem;
}

/* Group Header */
.group-header {
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    border: 1px solid #e5e7eb;
}

.group-header-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
}

.group-header-main {
    display: flex;
    align-items: center;
    gap: 2rem;
    flex: 1;
}

.group-logo-section {
    flex-shrink: 0;
}

.group-info-section {
    flex: 1;
    text-align: left;
}

.group-logo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid #e5e7eb;
    object-fit: cover;
    background: #f9fafb;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-sm);
}

.group-logo-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-sm);
}

.group-logo-placeholder i {
    font-size: 3rem;
    color: var(--text-secondary);
}

.group-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.group-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    line-height: 1.5;
}

.group-contact {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.group-contact i {
    font-size: 1rem;
    color: var(--text-secondary);
}

.contact-link {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.3s ease;
}

.contact-link:hover {
    color: var(--secondary-color);
    text-decoration: underline;
}

.group-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: flex-start;
}

.group-action-btn {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1.25rem;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: var(--shadow-sm);
}

.group-action-btn:hover {
    background: var(--bg-secondary);
    color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-color);
}

.group-action-btn.primary {
    background: var(--primary-gradient);
    color: white;
    font-weight: 700;
    border-color: transparent;
    box-shadow: var(--shadow-sm);
}

.group-action-btn.primary:hover {
    background: var(--primary-gradient);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.group-action-btn.secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: #e5e7eb;
}

.group-action-btn.secondary:hover {
    background: var(--bg-secondary);
    color: var(--primary-color);
    border-color: var(--primary-color);
}

/* Responsive Design */
@media (max-width: 768px) {
    .group-header-content {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }
    
    .group-header-main {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .group-info-section {
        text-align: center;
    }
    
    .group-actions {
        justify-content: center;
        gap: 0.5rem;
    }
    
    .group-action-btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
    }
    
    .group-title {
        font-size: 2rem;
    }
    
    .group-subtitle {
        font-size: 1rem;
    }
}

/* Main Content Layout */
.group-main-content {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
    margin-bottom: 2rem;
}

.group-main {
    min-width: 0;
}

.group-sidebar {
    min-width: 0;
}

/* Content Cards */
.group-card {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.group-card-header {
    background: linear-gradient(135deg, var(--bg-primary) 0%, #e2e8f0 100%);
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.group-card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.group-card-header i {
    color: var(--primary-color);
    font-size: 1.5rem;
}

.group-card-body {
    padding: 1.5rem;
}

/* About Section */
.group-description {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #374151;
}

.group-description-html {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #374151;
}

/* Leadership Section */
.leadership-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.leader-card {
    background: #f8fafc;
    border-radius: 0.75rem;
    padding: 1rem;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.leader-card:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.leader-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 0.75rem;
}

.leader-initials {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-gradient);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
}

.leader-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.leader-role {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
}

.leader-actions {
    display: flex;
    gap: 0.5rem;
}

.leader-btn {
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.leader-btn:hover {
    background: #f3f4f6;
    color: #1f2937;
    text-decoration: none;
}

.leader-btn.telegram {
    color: #0088cc;
    border-color: #0088cc;
}

.leader-btn.telegram:hover {
    background: #0088cc;
    color: white;
}

.leader-btn.discord {
    color: #5865f2;
    border-color: #5865f2;
}

.leader-btn.discord:hover {
    background: #5865f2;
    color: white;
}

/* Events Section */
.events-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.toggle-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    color: #6b7280;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.toggle-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.event-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1.25rem;
    transition: all 0.3s ease;
}

.event-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.event-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.75rem;
    text-decoration: none;
}

.event-title:hover {
    color: #667eea;
}

.event-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.event-meta i {
    font-size: 1rem;
}

.event-rsvp {
    background: #f3f4f6;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    color: #374151;
    font-weight: 500;
}

.event-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.event-link:hover {
    text-decoration: underline;
}

/* Sidebar */
.sidebar-card {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.sidebar-card-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    color: #1f2937;
}

.sidebar-card-body {
    padding: 1.5rem;
}

.sidebar-stat {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.sidebar-stat:last-child {
    border-bottom: none;
}

.sidebar-stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.sidebar-stat-value {
    font-weight: 600;
    color: #1f2937;
}

/* Telegram Feed Styling */
.header-link {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: color 0.3s ease;
}

.header-link:hover {
    color: var(--secondary-color);
}

.telegram-feed {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.telegram-post {
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 1rem;
    background: #f9fafb;
    transition: all 0.3s ease;
}

.telegram-post:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.post-header i {
    font-size: 1rem;
    color: var(--primary-color);
}

.post-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.post-title {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    line-height: 1.4;
    transition: color 0.3s ease;
}

.post-title:hover {
    color: var(--primary-color);
}

.post-summary {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .group-main-content {
        grid-template-columns: 1fr;
    }
    
    .group-title {
        font-size: 2rem;
    }
    
    .group-actions {
        flex-direction: column;
    }
    
    .group-action-btn {
        justify-content: center;
    }
    
    .leadership-grid {
        grid-template-columns: 1fr;
    }
    
    .events-grid {
        grid-template-columns: 1fr;
    }
    
    .telegram-post {
        padding: 0.75rem;
    }
    
    .post-title {
        font-size: 0.95rem;
    }
    
    .post-summary {
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="container py-3">
    <nav class="modern-breadcrumbs">
        <a href="{% url 'home' %}">
            <span class="material-icons">home</span>
            Home
        </a>
        <span class="breadcrumb-chevron">›</span>
        <a href="{% url 'groups_list' %}">
            <span class="material-icons">group</span>
            Groups
        </a>
        <span class="breadcrumb-chevron">›</span>
        <span class="breadcrumb-current">
            <span class="material-icons">group</span>
            {{ group.name }}
        </span>
    </nav>
</div>

<div class="group-page-container">
    <!-- Group Header -->
    <div class="group-header">
        <div class="container">
            <div class="group-header-content">
                <div class="group-header-main">
                    <div class="group-logo-section">
                        {% if group.logo_base64 %}
                            <img src="data:image/png;base64,{{ group.logo_base64 }}" alt="{{ group.name }} Logo" class="group-logo">
                        {% else %}
                            <div class="group-logo-placeholder">
                                <i class="material-icons">groups</i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="group-info-section">
                        <h1 class="group-title">{{ group.name }}</h1>
                        
                        {% if group.description %}
                            <p class="group-subtitle">{{ group.description|striptags|truncatewords:25 }}</p>
                        {% endif %}
                        
                        {% if group.contact_email %}
                            <div class="group-contact">
                                <i class="material-icons">email</i>
                                <a href="mailto:{{ group.contact_email }}" class="contact-link">{{ group.contact_email }}</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="group-actions">
                    {% if can_edit_group %}
                        <button class="group-action-btn primary" data-bs-toggle="modal" data-bs-target="#editGroupModal">
                            <i class="material-icons">settings</i>
                            Manage Group
                        </button>
                    {% endif %}
                    
                    {% if group.website %}
                        <a href="{{ group.website }}" target="_blank" class="group-action-btn secondary">
                            <i class="material-icons">language</i>
                            Website
                        </a>
                    {% endif %}
                    
                    {% if group.telegram_channel %}
                        <a href="https://t.me/{{ group.telegram_channel|cut:'@' }}" target="_blank" class="group-action-btn secondary">
                            <i class="material-icons">send</i>
                            General Channel
                        </a>
                    {% endif %}
                    
                    {% if group.telegram_announcements %}
                        <a href="https://t.me/{{ group.telegram_announcements|cut:'@' }}" target="_blank" class="group-action-btn secondary">
                            <i class="material-icons">campaign</i>
                            Announcements
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="group-main-content">
            <!-- Main Column -->
            <div class="group-main">
                <!-- About Section -->
                <div class="group-card">
                    <div class="group-card-header">
                        <i class="material-icons">info</i>
                        <h3>About This Group</h3>
                    </div>
                    <div class="group-card-body">
                        {% if group.description %}
                            <div class="group-description-html">{{ group.description|safe }}</div>
                        {% else %}
                            <p class="text-muted fst-italic">No description provided yet.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Leadership Section -->
                <div class="group-card">
                    <div class="group-card-header">
                        <i class="material-icons">people</i>
                        <h3>Group Leadership</h3>
                    </div>
                    <div class="group-card-body">
                        {% if leadership_roles %}
                            <div class="leadership-grid">
                                {% for role in leadership_roles %}
                                    <div class="leader-card">
                                        <div>
                                            {% if role.user.profile.profile_picture_base64 %}
                                                <img src="{{ role.user.profile.profile_picture_base64 }}" alt="{{ role.user.profile.get_display_name }}" class="leader-avatar">
                                            {% else %}
                                                <div class="leader-initials">
                                                    {{ role.user.profile.get_initials }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="leader-name">
                                            {{ role.user.profile.get_display_name }}
                                            {% verified_checkmark role.user %}
                                        </div>
                                        {% if role.custom_label %}
                                            <div class="leader-role">{{ role.custom_label }}</div>
                                        {% endif %}
                                        <div class="leader-actions">
                                            {% if role.user.profile.telegram_username %}
                                                <a href="https://t.me/{{ role.user.profile.telegram_username }}" target="_blank" class="leader-btn telegram">
                                                    <i class="material-icons">send</i>
                                                    Telegram
                                                </a>
                                            {% endif %}
                                            {% if role.user.profile.discord_username %}
                                                <button type="button" class="leader-btn discord" data-discord-popup data-discord="{{ role.user.profile.discord_username }}" data-display-name="{{ role.user.profile.get_display_name }}">
                                                    <i class="material-icons">chat</i>
                                                    Discord
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="material-icons mb-3" style="font-size: 3rem; color: #9ca3af;">people_outline</i>
                                <p class="text-muted">No leaders assigned to this group yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Events Section -->
                <div class="group-card">
                    <div class="group-card-header">
                        <i class="material-icons">event</i>
                        <h3>Upcoming Events</h3>
                    </div>
                    <div class="group-card-body">
                        {% if upcoming_events %}
                            <div class="events-toggle">
                                <button class="toggle-btn active" data-view="grid">Grid View</button>
                                <button class="toggle-btn" data-view="list">List View</button>
                            </div>
                            
                            <!-- Event Filters -->
                            <div class="event-filters mb-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="filter-label-modern">
                                            <span class="material-icons">search</span>
                                            Search Events
                                        </label>
                                        <input type="text" id="eventSearch" class="form-control search-input-modern" 
                                               placeholder="Search events by title, description, or location..." 
                                               onkeyup="filterEvents()">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="filter-label-modern">
                                            <span class="material-icons">sort</span>
                                            Sort By
                                        </label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="filter-btn-modern active" 
                                                    onclick="sortEvents('date', event)">
                                                <span class="material-icons">calendar_today</span>
                                                Date
                                            </button>
                                            <button type="button" class="filter-btn-modern" 
                                                    onclick="sortEvents('title', event)">
                                                <span class="material-icons">title</span>
                                                Title
                                            </button>
                                            <button type="button" class="filter-btn-modern" 
                                                    onclick="sortEvents('rsvps', event)">
                                                <span class="material-icons">people</span>
                                                RSVPs
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="filter-label-modern">
                                            <span class="material-icons">filter_list</span>
                                            Filter Events
                                        </label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="filter-btn-modern active" 
                                                    onclick="filterByType('all', event)">
                                                <span class="material-icons">all_inclusive</span>
                                                All Events
                                            </button>
                                            <button type="button" class="filter-btn-modern" 
                                                    onclick="filterByType('upcoming', event)">
                                                <span class="material-icons">schedule</span>
                                                Upcoming
                                            </button>
                                            <button type="button" class="filter-btn-modern" 
                                                    onclick="filterByType('full', event)">
                                                <span class="material-icons">event_busy</span>
                                                Full Events
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="filter-label-modern">
                                            <span class="material-icons">view_module</span>
                                            View Options
                                        </label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="filter-btn-modern active" 
                                                    onclick="setEventViewMode('grid', event)">
                                                <span class="material-icons">grid_view</span>
                                                Grid
                                            </button>
                                            <button type="button" class="filter-btn-modern" 
                                                    onclick="setEventViewMode('list', event)">
                                                <span class="material-icons">view_list</span>
                                                List
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="eventsGrid" class="events-grid">
                                {% for event in upcoming_events %}
                                    <div class="event-card" data-title="{{ event.title|lower }}" data-date="{{ event.date|date:'Y-m-d' }}" data-rsvps="{{ event.confirmed_count|default:0 }}" data-capacity="{{ event.capacity|default:0 }}" data-type="{% if event.capacity and event.confirmed_count >= event.capacity %}full{% else %}upcoming{% endif %}">
                                        <a href="{% url 'event_detail' event.id %}" class="event-title">
                                            {{ event.title }}
                                        </a>
                                        <div class="event-meta">
                                            <span><i class="material-icons">calendar_month</i> {{ event.date }}</span>
                                            {% if event.start_time %}
                                                <span><i class="material-icons">schedule</i> {{ event.start_time|time:"g:i A" }}</span>
                                            {% endif %}
                                        </div>
                                        {% if event.capacity %}
                                            <div class="event-rsvp">
                                                {{ event.confirmed_count|default:0 }} / {{ event.capacity }} RSVPs
                                            </div>
                                        {% endif %}
                                        <a href="{% url 'event_detail' event.id %}" class="event-link">View Event →</a>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div id="eventsList" class="events-list" style="display: none;">
                                {% for event in upcoming_events %}
                                    <div class="event-card" data-title="{{ event.title|lower }}" data-date="{{ event.date|date:'Y-m-d' }}" data-rsvps="{{ event.confirmed_count|default:0 }}" data-capacity="{{ event.capacity|default:0 }}" data-type="{% if event.capacity and event.confirmed_count >= event.capacity %}full{% else %}upcoming{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <a href="{% url 'event_detail' event.id %}" class="event-title">
                                                    {{ event.title }}
                                                </a>
                                                <div class="event-meta">
                                                    <span><i class="material-icons">calendar_month</i> {{ event.date }}</span>
                                                    {% if event.start_time %}
                                                        <span><i class="material-icons">schedule</i> {{ event.start_time|time:"g:i A" }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <a href="{% url 'event_detail' event.id %}" class="event-link">View Event →</a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="material-icons mb-3" style="font-size: 3rem; color: #9ca3af;">event_busy</i>
                                <p class="text-muted">No upcoming events for this group.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Telegram Announcements Section -->
                {% if telegram_feed %}
                <div class="group-card">
                    <div class="group-card-header">
                        <i class="material-icons">campaign</i>
                        <h3>Latest Announcements</h3>
                        {% if group.telegram_announcements %}
                            <a href="https://t.me/{{ group.telegram_announcements|cut:'@' }}" target="_blank" class="header-link">
                                <i class="material-icons">open_in_new</i>
                                View Channel
                            </a>
                                        {% endif %}
                                </div>
                    <div class="group-card-body">
                        <div class="telegram-feed">
                            {% for entry in telegram_feed %}
                                <div class="telegram-post" 
                                     data-title="{{ entry.title|escapejs }}" 
                                     data-summary="{{ entry.summary|striptags|escapejs }}" 
                                     data-link="{{ entry.link|escapejs }}" 
                                     data-date="{% if entry.est_datetime %}{{ entry.est_datetime|date:'M j, Y' }} at {{ entry.est_datetime|time:'g:i A' }}{% else %}{{ entry.published|default:'Unknown date' }}{% endif %}"
                                     onclick="openAnnouncementModal(this)">
                                    <div class="post-header">
                                        <i class="material-icons">campaign</i>
                                        <span class="post-date">
                                            {% if entry.est_datetime %}
                                                {{ entry.est_datetime|date:"M j, Y" }} at {{ entry.est_datetime|time:"g:i A" }}
                                            {% else %}
                                                {{ entry.published|default:"Unknown date" }}
                                            {% endif %}
                                        </span>
                                        </div>
                                    <div class="post-content">
                                        <span class="post-title">{{ entry.title }}</span>
                                        {% if entry.summary %}
                                            <p class="post-summary">{{ entry.summary|striptags|truncatewords:30 }}</p>
                                        {% endif %}
                                    </div>
                                    </div>
                            {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="group-sidebar">
                <!-- Group Stats -->
                <div class="sidebar-card">
                    <div class="sidebar-card-header">
                        Group Statistics
                </div>
                    <div class="sidebar-card-body">
                        <div class="sidebar-stat">
                            <span class="sidebar-stat-label">Total Events</span>
                            <span class="sidebar-stat-value">{{ upcoming_events|length }}</span>
                    </div>
                        <div class="sidebar-stat">
                            <span class="sidebar-stat-label">Group Leaders</span>
                            <span class="sidebar-stat-value">{{ leadership_roles|length }}</span>
                                    </div>
                                    </div>
                                    </div>

                <!-- Quick Actions -->
                <div class="sidebar-card">
                    <div class="sidebar-card-header">
                        Quick Actions
                                </div>
                    <div class="sidebar-card-body">
                        <div class="d-grid gap-2">
                            {% if user.is_authenticated %}
                                {% if can_edit_group or user.is_superuser %}
                                    <a href="{% url 'create_event' %}" class="btn btn-primary">
                                        <i class="material-icons">add_circle</i>
                                        Create Event
                                    </a>
                                {% endif %}
                                <a href="{% url 'groups_list' %}" class="btn btn-outline-primary">
                                    <i class="material-icons">groups</i>
                                    Browse Groups
                                </a>
                                                {% else %}
                                <a href="{% url 'login' %}" class="btn btn-primary">
                                    <i class="material-icons">login</i>
                                    Join FURsvp
                                </a>
                                                {% endif %}
                                            </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                    </div>
</div>

<!-- Announcement Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title d-flex align-items-center" id="announcementModalLabel">
                    <span class="material-icons me-2">campaign</span> Announcement
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Date:</strong>
                    <span id="modalAnnouncementDate"></span>
                </div>
                <div class="mb-3">
                    <strong>Title:</strong>
                    <h4 id="modalAnnouncementTitle"></h4>
                </div>
                <div class="mb-3">
                    <strong>Content:</strong>
                    <div id="modalAnnouncementContent" class="mt-2" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <hr>
                <div class="text-center">
                    <a href="#" id="modalAnnouncementLink" target="_blank" class="btn btn-primary">
                        <span class="material-icons me-2">open_in_new</span>
                        View on Telegram
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Group Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel">
                    <i class="material-icons">settings</i>
                    Manage Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                <div class="modal-body">
                <ul class="nav nav-tabs" id="groupManageTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">
                            <i class="material-icons">edit</i>
                            Edit Group
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="leadership-tab" data-bs-toggle="tab" data-bs-target="#leadership" type="button" role="tab">
                            <i class="material-icons">people</i>
                            Manage Leadership
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="groupManageTabsContent">
                    <div class="tab-pane fade show active" id="edit" role="tabpanel">
                        <form method="post" action="{% url 'group_detail' group.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="submit_group_edit" value="1">
                            
                    <div class="mb-3">
                                <label for="group_name" class="form-label">Group Name</label>
                                <input type="text" class="form-control" id="group_name" name="group_name" value="{{ group.name }}" required>
                    </div>
                            
                    <div class="mb-3">
                                <label for="group_description" class="form-label">Description</label>
                                <textarea class="form-control" id="group_description" name="group_description" rows="4">{{ group.description|striptags }}</textarea>
                        </div>
                            
                    <div class="mb-3">
                                <label for="group_website" class="form-label">Website</label>
                                <input type="url" class="form-control" id="group_website" name="group_website" value="{{ group.website|default:'' }}">
                    </div>
                            
                    <div class="mb-3">
                                <label for="group_telegram" class="form-label">Telegram Event Channel</label>
                                <input type="text" class="form-control" id="group_telegram" name="group_telegram" value="{{ group.telegram_channel|default:'' }}" placeholder="@channelname">
                                <div class="form-text">This channel will receive event announcements and updates posted from FURsvp.</div>
                    </div>
                            
                    <div class="mb-3">
                                <label for="group_telegram_announcements" class="form-label">Telegram Announcement Channel</label>
                                <input type="text" class="form-control" id="group_telegram_announcements" name="group_telegram_announcements" value="{{ group.telegram_announcements|default:'' }}" placeholder="@announcements">
                                <div class="form-text">This channel will receive general announcements and group updates posted from Telegram.</div>
                    </div>
                            
                    <div class="mb-3">
                                <label for="group_email" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="group_email" name="group_email" value="{{ group.contact_email|default:'' }}">
                    </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="material-icons">save</i>
                                    Save Changes
                    </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
</div>

                    <div class="tab-pane fade" id="leadership" role="tabpanel">
                        <form method="post" action="{% url 'group_detail' group.id %}">
                    {% csrf_token %}
                            <input type="hidden" name="submit_leadership_changes" value="1">
                
                <div class="mb-3">
                                <label class="form-label">Current Leaders</label>
                                {% for role in leadership_roles %}
                                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                        {% if role.user.profile.profile_picture_base64 %}
                                                <img src="{{ role.user.profile.profile_picture_base64 }}" alt="{{ role.user.profile.get_display_name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                        {% else %}
                                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">
                                                {{ role.user.profile.get_initials }}
                                            </div>
                                        {% endif %}
                                        <span>{{ role.user.profile.get_display_name }}</span>
                                            {% if role.custom_label %}
                                                <span class="badge bg-secondary">{{ role.custom_label }}</span>
                            {% endif %}
                </div>
                                        <button type="submit" name="remove_leader_{{ role.user.id }}" class="btn btn-sm btn-outline-danger">
                                            <i class="material-icons">remove</i>
                                            </button>
            </div>
                                {% endfor %}
            </div>
                            
                            <div class="mb-3">
                                <label for="new_leader" class="form-label">Add New Leader</label>
                                <select class="form-select tom-select-leader" id="new_leader" name="new_leader">
                                    <option value="">Select a user...</option>
                                    {% for user_obj in all_users %}
                                        <option value="{{ user_obj.id }}" 
                                                data-username="@{{ user_obj.username }}"
                                                data-display-name="{{ user_obj.profile.get_display_name }}"
                                                data-avatar-color="{{ user_obj.profile.get_avatar_color }}"
                                                data-has-pfp="{% if user_obj.profile.profile_picture_base64 %}true{% else %}false{% endif %}"
                                                data-search="{{ user_obj.profile.get_display_name }} {{ user_obj.username }}">
                                            {{ user_obj.profile.get_display_name }} (@{{ user_obj.username }})
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if user.is_superuser %}
                                    <div class="form-text">Staff can add any user as a leader.</div>
                            {% else %}
                                    <div class="form-text">Only users not already in the group are shown.</div>
{% endif %}
                </div>
                            
                            <div class="mb-3">
                                <label for="leader_role" class="form-label">Role Label (Optional)</label>
                                <input type="text" class="form-control" id="leader_role" name="leader_role" placeholder="e.g., Founder, Moderator, etc.">
      </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" name="add_leader" class="btn btn-primary">
                                    <i class="material-icons">add</i>
                                    Add Leader
            </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
                        </form>
      </div>
      </div>
    </div>
  </div>
</div>

<!-- Discord Contact Modal -->
<div class="modal fade" id="discordModal" tabindex="-1" aria-labelledby="discordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header discord-modal-header">
                <h5 class="modal-title" id="discordModalTitle">
                    <span class="material-icons">chat</span>
                    Discord Contact
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="discord-input-group">
                    <input type="text" class="form-control discord-input" id="discordUsername" readonly>
                        <button class="btn discord-copy-btn" type="button" onclick="copyDiscordUsername(event)">
                        <span class="material-icons">content_copy</span>
                        <span>Copy</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
// Initialize Quill.js for edit group modal
function initQuill() {
    const isDark = document.body.classList.contains('dark-mode') || 
                  document.documentElement.classList.contains('dark-mode') ||
                  window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    const descriptionField = document.querySelector('#editGroupModal textarea[name="description"]');
    
    if (!descriptionField) return;
    
    // Create Quill container
    const quillContainer = document.createElement('div');
    quillContainer.id = 'quill-editor-group';
    quillContainer.style.height = '300px';
    descriptionField.parentNode.insertBefore(quillContainer, descriptionField);
    descriptionField.style.display = 'none';
    
    // Initialize Quill
    const quill = new Quill('#quill-editor-group', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: 'Describe your group...',
        readOnly: false
    });
    
    // Set initial content if any
    if (descriptionField.value) {
        quill.root.innerHTML = descriptionField.value;
    }
    
    // Sync Quill content with hidden textarea
    quill.on('text-change', function() {
        descriptionField.value = quill.root.innerHTML;
    });
    
    // Dark mode support
    if (isDark) {
        quillContainer.querySelector('.ql-toolbar').style.backgroundColor = '#2d3748';
        quillContainer.querySelector('.ql-toolbar').style.borderColor = '#4a5568';
        quillContainer.querySelector('.ql-container').style.backgroundColor = '#2d3748';
        quillContainer.querySelector('.ql-container').style.borderColor = '#4a5568';
        quillContainer.querySelector('.ql-editor').style.color = '#e2e8f0';
    }
}

// Initialize Quill when edit group modal is shown
const editGroupModal = document.getElementById('editGroupModal');
if (editGroupModal) {
    editGroupModal.addEventListener('shown.bs.modal', function () {
        setTimeout(initQuill, 100);
    });
}

// Events view toggle
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    const eventsGrid = document.getElementById('eventsGrid');
    const eventsList = document.getElementById('eventsList');
    
    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Update active button
            toggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide views
            if (view === 'grid') {
                eventsGrid.style.display = 'grid';
                eventsList.style.display = 'none';
            } else {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
            }
        });
    });
    
    // Discord popup functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-discord-popup]')) {
            e.preventDefault();
            const button = e.target.closest('[data-discord-popup]');
            const discord = button.getAttribute('data-discord');
            const displayName = button.getAttribute('data-display-name');
            
            // Update modal content
            document.getElementById('discordModalTitle').textContent = `Contact ${displayName} on Discord`;
            document.getElementById('discordUsername').value = discord;
            
            // Show the modal
            const discordModal = new bootstrap.Modal(document.getElementById('discordModal'));
            discordModal.show();
        }
    });
    
    // Handle remove leader buttons in the modal
    document.addEventListener('click', function(e) {
        if (e.target.closest('button[name^="remove_leader_"]')) {
            e.preventDefault();
            const button = e.target.closest('button[name^="remove_leader_"]');
            const userName = button.closest('.d-flex').querySelector('span').textContent;
            
            if (confirm(`Are you sure you want to remove ${userName} as a leader?`)) {
                // Submit the form
                const form = button.closest('form');
                if (form) {
                    form.submit();
                }
            }
        }
    });
    
    // Initialize Tom Select for leader selection with avatars
    const leaderSelect = document.getElementById('new_leader');
    if (leaderSelect) {
        // Cache for avatars
        const avatarCache = new Map();
        
        // Function to fetch avatar
        async function fetchAvatar(userId) {
            if (avatarCache.has(userId)) {
                return avatarCache.get(userId);
            }
            
            try {
                const response = await fetch(`/users/avatar/${userId}/`);
                const data = await response.json();
                avatarCache.set(userId, data);
                return data;
            } catch (error) {
                console.error('Error fetching avatar:', error);
                return null;
            }
        }
        
        // Function to create avatar HTML
        function createAvatarHtml(avatarData, size = 24) {
            if (avatarData && avatarData.has_pfp && avatarData.avatar) {
                return `<img src="${avatarData.avatar}" alt="Profile" style="width: ${size}px; height: ${size}px; border-radius: 50%; object-fit: cover;">`;
            } else {
                const initials = avatarData ? avatarData.initials : 'U';
                const color = avatarData ? avatarData.color : '#667eea';
                return `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; background-color: ${color}; display: flex; align-items: center; justify-content: center; color: white; font-size: ${size * 0.5}px; font-weight: bold;">${initials}</div>`;
            }
        }
        
        // Pre-load avatars for all options
        async function preloadAvatars() {
            const options = leaderSelect.querySelectorAll('option[value]');
            const promises = [];
            
            for (const option of options) {
                const userId = option.value;
                if (userId && !avatarCache.has(userId)) {
                    promises.push(fetchAvatar(userId));
                }
            }
            
            await Promise.all(promises);
        }
        
        // Initialize Tom Select with synchronous render functions
        const tomSelect = new TomSelect(leaderSelect, {
            render: {
                option: function(data, escape) {
                    // Get data from the option element
                    const option = data.option || data;
                    const displayName = option.dataset ? option.dataset.displayName : '';
                    const username = option.dataset ? option.dataset.username : '';
                    const userId = data.value;
                    
                    // Get avatar data from cache (should be pre-loaded)
                    const avatarData = avatarCache.get(userId);
                    
                    // Create avatar HTML
                    const avatarHtml = createAvatarHtml(avatarData, 24);
                    
                    return `<div style="display: flex; align-items: center; gap: 8px;">
                        ${avatarHtml}
                        <div>
                            <div style="font-weight: 600;">${escape(displayName || data.text)}</div>
                            <div style="font-size: 12px; color: #6b7280;">${escape(username)}</div>
                        </div>
                    </div>`;
                },
                item: function(data, escape) {
                    // Get data from the option element
                    const option = data.option || data;
                    const displayName = option.dataset ? option.dataset.displayName : '';
                    const userId = data.value;
                    
                    // Get avatar data from cache
                    const avatarData = avatarCache.get(userId);
                    
                    // Create avatar HTML for selected item
                    const avatarHtml = createAvatarHtml(avatarData, 20);
                    
                    return `<div style="display: flex; align-items: center; gap: 6px;">
                        ${avatarHtml}
                        <span>${escape(displayName || data.text)}</span>
                    </div>`;
                }
            },
            placeholder: 'Select a user...',
            create: false,
            maxItems: 1,
            closeAfterSelect: true,
            sortField: 'text',
            searchField: ['text', 'data-search']
        });
        
        // Pre-load avatars after Tom Select is initialized
        preloadAvatars().then(() => {
            // Refresh the dropdown to show avatars
            tomSelect.refreshOptions();
        });
    }
});

function copyDiscordUsername(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const input = document.getElementById('discordUsername');
    const textToCopy = input.value;
    const button = event.target.closest('button');
    
    // Use modern clipboard API if available, fallback to execCommand
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showCopyFeedback(button);
        }).catch(() => {
            // Fallback to execCommand
            fallbackCopyTextToClipboard(input);
            showCopyFeedback(button);
        });
    } else {
        // Fallback to execCommand for older browsers
        fallbackCopyTextToClipboard(input);
        showCopyFeedback(button);
    }
}

function fallbackCopyTextToClipboard(input) {
    input.select();
    input.setSelectionRange(0, 99999);
    try {
        document.execCommand('copy');
    } catch (err) {
        console.error('Failed to copy: ', err);
    }
}

function showCopyFeedback(button) {
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="material-icons">check</span><span>Copied!</span>';
    button.classList.add('copied');
    
    setTimeout(() => {
        button.innerHTML = originalContent;
        button.classList.remove('copied');
    }, 2000);
}

// Event filtering and sorting functions
let currentEventTypeFilter = 'all';
let currentEventSortBy = 'date';
let currentEventViewMode = 'grid';

function filterEvents() {
    const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
    const eventCards = document.querySelectorAll('.event-card');
    
    eventCards.forEach(card => {
        const title = card.getAttribute('data-title') || '';
        const type = card.getAttribute('data-type') || '';
        const matchesSearch = title.includes(searchTerm);
        const matchesType = currentEventTypeFilter === 'all' || type === currentEventTypeFilter;
        
        if (matchesSearch && matchesType) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

function filterByType(type, event) {
    currentEventTypeFilter = type;
    
    // Update button states
    document.querySelectorAll('[onclick^="filterByType"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    filterEvents();
}

function sortEvents(sortBy, event) {
    currentEventSortBy = sortBy;
    
    // Update button states
    document.querySelectorAll('[onclick^="sortEvents"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const eventsGrid = document.getElementById('eventsGrid');
    const eventsList = document.getElementById('eventsList');
    
    [eventsGrid, eventsList].forEach(container => {
        if (!container) return;
        
        const items = Array.from(container.querySelectorAll('.event-card:not(.hidden)'));
        
        items.sort((a, b) => {
            let aValue, bValue;
            
            switch(sortBy) {
                case 'title':
                    aValue = a.getAttribute('data-title') || '';
                    bValue = b.getAttribute('data-title') || '';
                    return aValue.localeCompare(bValue);
                case 'date':
                    aValue = a.getAttribute('data-date') || '';
                    bValue = b.getAttribute('data-date') || '';
                    return new Date(aValue) - new Date(bValue); // Earliest first
                case 'rsvps':
                    aValue = parseInt(a.getAttribute('data-rsvps') || '0');
                    bValue = parseInt(b.getAttribute('data-rsvps') || '0');
                    return bValue - aValue; // Most RSVPs first
                default:
                    return 0;
            }
        });
        
        // Re-append sorted items
        items.forEach(item => container.appendChild(item));
    });
}

function setEventViewMode(mode, event) {
    currentEventViewMode = mode;
    
    // Update button states
    document.querySelectorAll('[onclick^="setEventViewMode"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const eventsGrid = document.getElementById('eventsGrid');
    const eventsList = document.getElementById('eventsList');
    
    if (mode === 'grid') {
        eventsGrid.style.display = 'grid';
        eventsList.style.display = 'none';
    } else {
        eventsGrid.style.display = 'none';
        eventsList.style.display = 'block';
    }
}

// Announcement modal functionality
function openAnnouncementModal(element) {
    const title = element.getAttribute('data-title');
    const summary = element.getAttribute('data-summary');
    const link = element.getAttribute('data-link');
    const date = element.getAttribute('data-date');
    
    // Populate modal content
    document.getElementById('modalAnnouncementTitle').textContent = title;
    document.getElementById('modalAnnouncementDate').textContent = date;
    document.getElementById('modalAnnouncementContent').innerHTML = summary;
    document.getElementById('modalAnnouncementLink').href = link;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('announcementModal'));
    modal.show();
    
    // Ensure modal is properly closed when clicking outside or pressing escape
    document.getElementById('announcementModal').addEventListener('hidden.bs.modal', function () {
        // Reset modal content
        document.getElementById('modalAnnouncementTitle').textContent = '';
        document.getElementById('modalAnnouncementDate').textContent = '';
        document.getElementById('modalAnnouncementContent').innerHTML = '';
        document.getElementById('modalAnnouncementLink').href = '#';
    });
}
</script>

<style>
/* Tom Select styling for leader selection */
.tom-select-leader .ts-wrapper {
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    background: white;
}

.tom-select-leader .ts-wrapper:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.tom-select-leader .ts-control {
    border: none;
    background: transparent;
    padding: 0.75rem 1rem;
    min-height: 48px;
}

.tom-select-leader .ts-dropdown {
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    max-height: 200px;
}

.tom-select-leader .ts-dropdown .option {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f5f9;
}

.tom-select-leader .ts-dropdown .option:hover {
    background: #f8fafc;
}

.tom-select-leader .ts-dropdown .option.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Discord Modal Styling */
.discord-modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
}

.discord-modal-header .modal-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
}

.discord-modal-header .btn-close {
    filter: invert(1);
    opacity: 0.8;
}

.discord-modal-header .btn-close:hover {
    opacity: 1;
}

.discord-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
}

.discord-input {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    background: #f8fafc;
    color: #2d3748;
    flex: 1;
}

.discord-input:focus {
    outline: none;
    border-color: #667eea;
    background: white;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.discord-copy-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.discord-copy-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    color: white;
}

.discord-copy-btn.copied {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}

.modal-footer {
    border-top: 1px solid #e2e8f0;
    padding: 1rem 1.5rem;
}

.modal-footer .btn-secondary {
    background: #f1f5f9;
    border: 2px solid #e2e8f0;
    color: #64748b;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.modal-footer .btn-secondary:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
    color: #475569;
}

/* Announcement Modal Content Styling */
#modalAnnouncementContent img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 0.5rem 0;
}

#modalAnnouncementContent {
    line-height: 1.6;
    color: #2d3748;
}

#modalAnnouncementContent p {
    margin-bottom: 1rem;
}

#modalAnnouncementContent a {
    color: #667eea;
    text-decoration: none;
}

#modalAnnouncementContent a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}