{% extends 'events/base.html' %}
{% block title %}Create Event - FURsvp{% endblock %}
{% load widget_tweaks %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Progress Bar Styles -->
<style>
.progress-container {
    max-width: 800px;
    margin: 0 auto 2rem auto;
    width: 100%;
}

.progress-bar {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    gap: 1rem;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 0;
    text-align: center;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    flex-shrink: 0;
    margin-bottom: 0.5rem;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
    text-align: center;
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* Step states */
.progress-step.completed .step-number {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

.progress-step.current .step-number {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    transform: scale(1.1);
}

.progress-step.pending .step-number {
    background: #f1f5f9;
    color: #94a3b8;
    border-color: #e2e8f0;
}

/* Labels */
.progress-step.completed .step-label {
    color: #10b981;
    font-weight: 600;
}

.progress-step.current .step-label {
    color: #4f46e5;
    font-weight: 600;
}

.progress-step.pending .step-label {
    color: #64748b;
}



/* Animation for step transitions */
@keyframes stepActivate {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1.1);
    }
}

.progress-step.current .step-number {
    animation: stepActivate 0.3s ease;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .progress-bar {
        padding: 1rem;
        gap: 0.5rem;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }
    
    .step-label {
        font-size: 0.75rem;
        display: none;
    }
    
    .progress-step.current .step-label {
        display: block;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        z-index: 10;
    }
}
</style>
<style>
/* Clean, modern styles */
.wizard-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label.required::after {
    content: ' *';
    color: #ef4444;
    font-weight: 700;
}

.form-control, .form-select {
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus, .form-select:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    background: white;
}

/* Reset focus states for flatpickr inputs when not active */
.flatpickr-date:not(:focus):not(.active),
.flatpickr-time:not(:focus):not(.active) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
}

/* Nuclear option - force all flatpickr inputs to have correct border */
input[type="text"].flatpickr-date,
input[type="text"].flatpickr-time {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

input[type="text"].flatpickr-date:focus,
input[type="text"].flatpickr-time:focus {
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
}

/* Flatpickr input field styling */
.flatpickr-date, .flatpickr-time {
    cursor: pointer;
    background: white !important;
    border: 2px solid #e2e8f0 !important;
    transition: all 0.3s ease !important;
}

.flatpickr-date:focus, .flatpickr-time:focus {
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
    background: white !important;
}

/* Force reset all focus states when not active */
.flatpickr-date:not(:focus), .flatpickr-time:not(:focus),
.flatpickr-date:not(.active), .flatpickr-time:not(.active),
.flatpickr-date:not([data-focus]), .flatpickr-time:not([data-focus]) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

/* Override any flatpickr-specific classes */
.flatpickr-input:not(:focus),
.flatpickr-input:not(.active) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

/* Fix z-index and positioning issues */
.flatpickr-calendar {
    z-index: 99999 !important;
    position: absolute !important;
}

.flatpickr-calendar.time {
    z-index: 99999 !important;
}

/* Ensure proper input group alignment */
.input-group .flatpickr-date,
.input-group .flatpickr-time {
    border-left: none !important;
    border-radius: 0 12px 12px 0 !important;
}

.input-group .input-group-text + .flatpickr-date,
.input-group .input-group-text + .flatpickr-time {
    border-left: none !important;
}

.input-group-text {
    background: #f1f5f9;
    border: 2px solid #e2e8f0;
    border-right: none;
    border-radius: 12px 0 0 12px;
    color: #64748b;
}

.input-group .form-control {
    border-left: none;
    border-radius: 0 12px 12px 0;
}

/* Trix Editor Styling */
trix-editor {
    border-radius: 0 0 12px 12px !important;
    border: 2px solid #e2e8f0 !important;
    border-top: none !important;
    background: white !important;
    min-height: 200px !important;
    padding: 1.5rem !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin-top: -20px !important;
    position: relative !important;
    z-index: 1 !important;
}

trix-toolbar {
    border-radius: 12px 12px 0 0 !important;
    border: 2px solid #e2e8f0 !important;
    border-bottom: none !important;
    background: #f8fafc !important;
    padding: 0.75rem !important;
    transform: scale(0.85) !important;
    transform-origin: top left !important;
    width: 117.65% !important;
    margin-bottom: 0 !important;
    position: relative !important;
    z-index: 2 !important;
}

trix-toolbar .trix-button-group {
    border: none !important;
    margin-right: 0.5rem !important;
}

trix-toolbar .trix-button {
    border: none !important;
    background: transparent !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    font-size: 1rem !important;
}

trix-toolbar .trix-button:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button.trix-active {
    background: #4f46e5 !important;
    color: white !important;
}

trix-toolbar .trix-button.trix-active:hover {
    background: #4338ca !important;
}

/* Custom attachment button styling */
trix-toolbar .trix-button--icon-attach {
    background: transparent !important;
    border: none !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
}

/* Fix divider and corner issues */
trix-toolbar .trix-button-group {
    border: none !important;
    margin-right: 0.75rem !important;
}

trix-toolbar .trix-button-group:not(:last-child) {
    border-right: 1px solid #e2e8f0 !important;
    padding-right: 0.75rem !important;
}

/* Ensure proper border radius and no gaps */
trix-toolbar {
    overflow: hidden !important;
}

/* Container styling to eliminate gaps */
trix-editor {
    display: block !important;
}

/* Override any default margins/padding that might cause gaps */
trix-editor:before,
trix-editor:after {
    display: none !important;
}

trix-toolbar .trix-button--icon-attach:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button--icon-attach .trix-button-icon {
    font-size: 1rem !important;
    line-height: 1 !important;
}

/* Ensure bold and italic button icons are visible */
trix-toolbar .trix-button--icon-bold .trix-button-icon,
trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-weight: bold !important;
    font-size: 1rem !important;
    line-height: 1 !important;
    color: #64748b !important;
    display: block !important;
}

trix-toolbar .trix-button--icon-bold .trix-button-icon {
    font-family: serif !important;
}

trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-style: italic !important;
    font-family: serif !important;
}

/* Attachment preview styling */
trix-editor .trix-attachment {
    border-radius: 8px !important;
    border: 1px solid #e2e8f0 !important;
    margin: 0.5rem 0 !important;
    padding: 0.5rem !important;
    background: #f8fafc !important;
}

trix-editor .trix-attachment__caption {
    color: #64748b !important;
    font-size: 0.875rem !important;
    margin-top: 0.25rem !important;
}

.review-summary {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.review-summary h5 {
    color: #1e293b;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.review-item {
    margin-bottom: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-item strong {
    color: #374151;
    font-weight: 600;
}

.review-item span {
    color: #64748b;
}

.agreement-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
}

.agreement-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 1rem;
}

.form-check {
    margin-bottom: 1rem;
}

.form-check-input {
    border-radius: 6px;
    border: 2px solid #e2e8f0;
}

.form-check-input:checked {
    background-color: #4f46e5;
    border-color: #4f46e5;
}

.form-check-label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Hide jQuery Steps Progress Bar */
.wizard > .steps {
    display: none !important;
}

/* Add step numbers */
.wizard > .steps > ul > li a::before {
    content: attr(data-step);
    display: block;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e2e8f0;
    color: #64748b;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.25rem;
}

.wizard > .steps > ul > li a:hover {
    background: #e2e8f0;
    color: #374151;
    transform: translateY(-2px);
}

.wizard > .steps > ul > li.current a {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    transform: translateY(-2px);
}

.wizard > .steps > ul > li.current a::before {
    background: white;
    color: #4f46e5;
}

.wizard > .steps > ul > li.done a {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

.wizard > .steps > ul > li.done a::before {
    background: white;
    color: #10b981;
}

.wizard > .steps > ul > li.error a {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
}

.wizard > .steps > ul > li.error a::before {
    background: white;
    color: #ef4444;
}

.wizard > .steps > ul > li.disabled a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .steps > ul > li.disabled a::before {
    background: #e2e8f0;
    color: #94a3b8;
}

/* Progress line between steps */
.wizard > .steps > ul > li:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 30px;
    right: -0.25rem;
    width: 0.5rem;
    height: 2px;
    background: #e2e8f0;
    z-index: 1;
}

.wizard > .steps > ul > li.done:not(:last-child)::after {
    background: #10b981;
}

.wizard > .steps > ul > li.current:not(:last-child)::after {
    background: linear-gradient(90deg, #10b981 0%, #4f46e5 100%);
}

/* Clean step text and remove redundant labels */
.wizard > .steps > ul > li a {
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.875rem;
    font-weight: 500;
}

/* Remove the "current step:" text completely */
.wizard > .steps > ul > li a::before {
    display: none !important;
}

/* Override any default text content */
.wizard > .steps > ul > li a {
    content: none !important;
}

/* Let jQuery Steps handle the visibility */
.wizard > .content > .body > section {
    /* Let the library handle this */
}

/* Hide the specific step headers */
#event-form-h-0,
#event-form-h-1,
#event-form-h-2,
#event-form-h-3,
#event-form-h-4,
#event-form-h-5 {
    display: none !important;
}

.wizard > .content {
    display: block;
    margin: 0;
    min-height: 500px;
    overflow: hidden;
    position: relative;
    width: auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.wizard > .content > .body {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 2rem;
    overflow: hidden;
}

.wizard > .content > .body ul {
    list-style: disc !important;
}

.wizard > .content > .body li {
    display: list-item;
}

.wizard > .content > .body blockquote {
    border-left: 3px solid #ccc;
    margin: 0;
    padding-left: 1em;
}

.wizard > .content > .body code {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
}

.wizard > .actions {
    position: relative;
    display: block;
    text-align: right;
    width: 100%;
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.wizard > .actions > ul {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 0;
    margin: 0;
}

.wizard > .actions > ul > li {
    display: inline-block;
}

.wizard > .actions a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    font-size: 1rem;
}

.wizard > .actions .disabled a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .actions .disabled a:hover {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .actions .disabled a:active {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .loading {
}

.wizard > .loading a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .loading a:hover {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .loading a:active {
    background: #f1f5f9;
    color: #94a3b8;
}

/* Flatpickr Theming */
.flatpickr-calendar {
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    padding: 0.5rem;
    width: auto;
    min-width: 280px;
    max-width: 320px;
    z-index: 9999;
}

.flatpickr-calendar.open {
    animation: flatpickr-fadeIn 0.3s ease-out;
}

@keyframes flatpickr-fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.flatpickr-months {
    background: #4f46e5;
    border-radius: 8px 8px 0 0;
    color: white;
    padding: 0.75rem;
    margin: -0.5rem -0.5rem 0.5rem -0.5rem;
}

.flatpickr-month {
    color: white;
    font-weight: 600;
}

.flatpickr-current-month {
    color: white;
    font-weight: 600;
}

.flatpickr-monthDropdown-months {
    background: transparent;
    color: white;
    border: none;
    font-weight: 600;
}

.flatpickr-monthDropdown-months option {
    background: white;
    color: #374151;
}

.flatpickr-weekdays {
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.flatpickr-weekday {
    color: #64748b;
    font-weight: 600;
    font-size: 0.875rem;
}

.flatpickr-days {
    background: white;
    border-radius: 8px;
}

.flatpickr-day {
    border-radius: 8px;
    margin: 2px;
    color: #374151;
    font-weight: 500;
    transition: all 0.2s ease;
}

.flatpickr-day:hover {
    background: #e2e8f0;
    color: #374151;
}

.flatpickr-day.selected {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

.flatpickr-day.selected:hover {
    background: #4338ca;
    color: white;
}

.flatpickr-day.today {
    background: #f1f5f9;
    color: #4f46e5;
    border-color: #4f46e5;
}

.flatpickr-day.today:hover {
    background: #e2e8f0;
    color: #4f46e5;
}

.flatpickr-day.disabled {
    color: #cbd5e1;
    background: transparent;
}

.flatpickr-day.disabled:hover {
    background: transparent;
    color: #cbd5e1;
}

.flatpickr-time {
    background: #f8fafc;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #e2e8f0;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.flatpickr-time input {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 16px;
    color: #374151;
    font-weight: 600;
    text-align: center;
    width: 80px;
    min-width: 80px;
    height: 50px;
    line-height: 1;
}

.flatpickr-time input:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    outline: none;
}

.flatpickr-time .flatpickr-am-pm {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    color: #374151;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 60px;
    text-align: center;
    height: 50px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.flatpickr-time .flatpickr-am-pm:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
}

.flatpickr-time .flatpickr-am-pm.selected {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

.flatpickr-time .flatpickr-am-pm.selected:hover {
    background: #4338ca;
    border-color: #4338ca;
}

/* Fix time picker positioning and sizing */
.flatpickr-calendar.time {
    width: auto;
    min-width: 250px;
    max-width: 350px;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    margin-top: 4px !important;
}

.flatpickr-time .numInputWrapper {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.flatpickr-time .numInputWrapper input {
    margin: 0;
}

/* Ensure proper spacing in time picker */
.flatpickr-time .flatpickr-time-separator {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0 0.25rem;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .form-card {
        padding: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
    }
    
    .wizard > .steps > ul > li a {
        margin: 0 0.25em 0.25em 0.25em;
        padding: 0.75rem;
        font-size: 0.875rem;
    }
    
    .wizard > .actions a {
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
    }
    
    .flatpickr-calendar {
        font-size: 12px;
        min-width: 250px;
        max-width: 280px;
    }
    
    .flatpickr-day {
        margin: 1px;
    }
    
    .flatpickr-time {
        padding: 0.75rem;
        gap: 0.25rem;
    }
    
    .flatpickr-time input {
        width: 70px;
        min-width: 70px;
        font-size: 14px;
        padding: 0.5rem;
        height: 45px;
    }
    
    .flatpickr-time .flatpickr-am-pm {
        min-width: 40px;
        padding: 0.5rem 0.75rem;
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="create-event-page">
    <div class="container">
        <!-- Breadcrumbs -->
        <div class="py-3">
            <nav class="modern-breadcrumbs">
                <a href="{% url 'home' %}">
                    <span class="material-icons">home</span>
                    Home
                </a>
                <span class="breadcrumb-chevron">›</span>
                <a href="{% url 'event_index' %}">
                    <span class="material-icons">event</span>
                    Events
                </a>
                <span class="breadcrumb-chevron">›</span>
                <span class="breadcrumb-current">
                    <span class="material-icons">add_circle</span>
                    Create Event
                </span>
            </nav>
        </div>

        <!-- Page Header -->
        <div class="page-header-modern">
            <h1 class="page-title-modern">
                <span class="material-icons">add_circle</span>
                Create New Event
            </h1>
            <p class="page-subtitle">Let's create your event step by step</p>
        </div>
        
        <div class="wizard-container">
            <!-- Horizontal Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-step" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Basic Information</div>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Schedule</div>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Location</div>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Settings</div>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-number">5</div>
                        <div class="step-label">Review & Submit</div>
                    </div>
                </div>
            </div>
            
            <form method="post" class="needs-validation" novalidate id="event-form">
                {% csrf_token %}
                
                                <!-- Step 1: Basic Information -->
                <h3>Basic Information</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">event_note</i>
                            Let's start with the basics
                        </div>
                            
                            <!-- Title Field -->
                            <div class="mb-4">
                                                            <label for="{{ form.title.id_for_label }}" class="form-label required">
                                <i class="material-icons">edit</i>
                                What's the name of your event?
                            </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    {{ form.title|add_class:'form-control'|attr:'placeholder:Enter event title' }}
                                </div>
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Group Field -->
                            <div class="mb-4">
                                                            <label for="{{ form.group.id_for_label }}" class="form-label required">
                                <i class="material-icons">groups</i>
                                Which group is hosting this event?
                            </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">groups</i>
                                    </span>
                                    {{ form.group|add_class:'form-select' }}
                                </div>
                                {% if form.group.help_text %}
                                    <div class="form-text text-muted">{{ form.group.help_text }}</div>
                                {% endif %}
                                {% if form.group.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.group.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Description Field -->
                            <div class="mb-4">
                                                                                        <label for="{{ form.description.id_for_label }}" class="form-label required">
                                <i class="material-icons">description</i>
                                Tell us about your event
                            </label>
                            <input type="hidden" id="{{ form.description.id_for_label }}" name="{{ form.description.name }}">
                            <trix-editor input="{{ form.description.id_for_label }}" placeholder="Describe your event in detail..."></trix-editor>
                            <div class="form-text text-muted">Describe what attendees can expect at your event.</div>
                            </div>
                        </div>
                </section>

                                <!-- Step 2: Schedule -->
                <h3>Schedule</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">schedule</i>
                            When is your event happening?
                        </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.date.id_for_label }}" class="form-label required">
                                        <i class="material-icons">event</i>
                                        What date is your event?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">event</i>
                                        </span>
                                        {{ form.date|add_class:'form-control flatpickr-date'|attr:'placeholder:Select date'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label required">
                                        <i class="material-icons">schedule</i>
                                        What time does it start?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">schedule</i>
                                        </span>
                                        {{ form.start_time|add_class:'form-control flatpickr-time'|attr:'placeholder:Start time'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label required">
                                        <i class="material-icons">schedule</i>
                                        What time does it end?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">schedule</i>
                                        </span>
                                        {{ form.end_time|add_class:'form-control flatpickr-time'|attr:'placeholder:End time'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                </section>

                                <!-- Step 3: Location -->
                <h3>Location</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">place</i>
                            Where is your event taking place?
                        </div>
                            
                            <!-- Current Location Button -->
                            <div class="mb-4">
                                <button type="button" id="useCurrentLocation" class="btn btn-outline-primary">
                                    <i class="material-icons">my_location</i>
                                    Use Current Location
                                </button>
                                <div id="locationStatus" class="mt-2" style="display: none;">
                                    <div class="alert alert-info" role="alert">
                                        <i class="material-icons">location_searching</i>
                                        Getting your location...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label required">
                                    <i class="material-icons">place</i>
                                    What's the street address?
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">place</i>
                                    </span>
                                    {{ form.address|add_class:'form-control'|attr:'placeholder:Street address'|attr:'required'|attr:'autocomplete:off' }}
                                </div>
                                <!-- Street Address Autocomplete Dropdown -->
                                <div id="addressAutocomplete" class="autocomplete-dropdown" style="display: none;">
                                    <ul class="list-group" id="addressSuggestions"></ul>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label required">
                                        <i class="material-icons">location_city</i>
                                        Which city?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">location_city</i>
                                        </span>
                                        {{ form.city|add_class:'form-control'|attr:'placeholder:City'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_state" class="form-label required">
                                        <i class="material-icons">map</i>
                                        Which state?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">map</i>
                                        </span>
                                        <select name="state" id="id_state" class="form-select" required>
                                            <option value="">Select State</option>
                                            <option value="Alabama">Alabama</option>
                                            <option value="Alaska">Alaska</option>
                                            <option value="Arizona">Arizona</option>
                                            <option value="Arkansas">Arkansas</option>
                                            <option value="California">California</option>
                                            <option value="Colorado">Colorado</option>
                                            <option value="Connecticut">Connecticut</option>
                                            <option value="Delaware">Delaware</option>
                                            <option value="Florida">Florida</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Hawaii">Hawaii</option>
                                            <option value="Idaho">Idaho</option>
                                            <option value="Illinois">Illinois</option>
                                            <option value="Indiana">Indiana</option>
                                            <option value="Iowa">Iowa</option>
                                            <option value="Kansas">Kansas</option>
                                            <option value="Kentucky">Kentucky</option>
                                            <option value="Louisiana">Louisiana</option>
                                            <option value="Maine">Maine</option>
                                            <option value="Maryland">Maryland</option>
                                            <option value="Massachusetts">Massachusetts</option>
                                            <option value="Michigan">Michigan</option>
                                            <option value="Minnesota">Minnesota</option>
                                            <option value="Mississippi">Mississippi</option>
                                            <option value="Missouri">Missouri</option>
                                            <option value="Montana">Montana</option>
                                            <option value="Nebraska">Nebraska</option>
                                            <option value="Nevada">Nevada</option>
                                            <option value="New Hampshire">New Hampshire</option>
                                            <option value="New Jersey">New Jersey</option>
                                            <option value="New Mexico">New Mexico</option>
                                            <option value="New York">New York</option>
                                            <option value="North Carolina">North Carolina</option>
                                            <option value="North Dakota">North Dakota</option>
                                            <option value="Ohio">Ohio</option>
                                            <option value="Oklahoma">Oklahoma</option>
                                            <option value="Oregon">Oregon</option>
                                            <option value="Pennsylvania">Pennsylvania</option>
                                            <option value="Rhode Island">Rhode Island</option>
                                            <option value="South Carolina">South Carolina</option>
                                            <option value="South Dakota">South Dakota</option>
                                            <option value="Tennessee">Tennessee</option>
                                            <option value="Texas">Texas</option>
                                            <option value="Utah">Utah</option>
                                            <option value="Vermont">Vermont</option>
                                            <option value="Virginia">Virginia</option>
                                            <option value="Washington">Washington</option>
                                            <option value="West Virginia">West Virginia</option>
                                            <option value="Wisconsin">Wisconsin</option>
                                            <option value="Wyoming">Wyoming</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                </section>

<style>
/* Autocomplete Dropdown Styles */
.autocomplete-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    margin-top: -1px;
}

.autocomplete-dropdown .list-group {
    margin: 0;
    border: none;
}

.autocomplete-dropdown .list-group-item {
    border: none;
    border-bottom: 1px solid #f0f0f0;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.autocomplete-dropdown .list-group-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-dropdown .list-group-item:last-child {
    border-bottom: none;
}

.autocomplete-dropdown .list-group-item .address-main {
    font-weight: 600;
    color: #333;
}

.autocomplete-dropdown .list-group-item .address-secondary {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Location Status Styles */
#locationStatus .alert {
    border-radius: 0.5rem;
    border: none;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1976d2;
}

#locationStatus .alert i {
    margin-right: 0.5rem;
}

/* Current Location Button Styles */
#useCurrentLocation {
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid #007bff;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: #007bff;
}

#useCurrentLocation:hover {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

#useCurrentLocation:active {
    transform: translateY(0);
}

#useCurrentLocation i {
    margin-right: 0.5rem;
}

/* Dark mode support */
.dark-mode .autocomplete-dropdown {
    background: #2d3748;
    border-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item {
    background: #2d3748;
    color: #e2e8f0;
    border-bottom-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item:hover {
    background-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item .address-main {
    color: #f7fafc;
}

.dark-mode .autocomplete-dropdown .list-group-item .address-secondary {
    color: #a0aec0;
}
</style>

                                <!-- Step 4: Settings -->
                <h3>Settings</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">settings</i>
                            Let's configure your event settings
                        </div>
                            
                            <!-- Capacity and Restrictions -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.age_restriction.id_for_label }}" class="form-label">
                                        <i class="material-icons">block</i>
                                        Is there an age restriction?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">block</i>
                                        </span>
                                        {{ form.age_restriction|add_class:'form-select' }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.capacity.id_for_label }}" class="form-label">
                                        <i class="material-icons">people_alt</i>
                                        How many people can attend?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">people_alt</i>
                                        </span>
                                        {{ form.capacity|add_class:'form-control'|attr:'placeholder:Enter event capacity (optional)' }}
                                    </div>
                                    <div class="form-text text-muted">Leave blank for unlimited capacity.</div>
                                    {% if form.capacity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.capacity.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Privacy Settings -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.waitlist_enabled|add_class:'form-check-input' }}
                                        <label class="form-check-label" for="{{ form.waitlist_enabled.id_for_label }}">
                                            <i class="material-icons">queue</i>
                                            Enable waitlist when full?
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.attendee_list_public|add_class:'form-check-input' }}
                                        <label class="form-check-label" for="{{ form.attendee_list_public.id_for_label }}">
                                            <i class="material-icons">visibility</i>
                                            Show attendee list publicly?
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Accessibility -->
                            <div class="mb-3">
                                <label for="{{ form.accessibility_details.id_for_label }}" class="form-label">
                                    <i class="material-icons">accessible</i>
                                    Is your venue accessible?
                                </label>
                                {{ form.accessibility_details|add_class:'form-control'|attr:'rows:3'|attr:'placeholder:Describe accessibility features (leave blank if not accessible)' }}
                                <div class="form-text text-muted">Tell us about wheelchair access, parking, etc.</div>
                            </div>
                        </div>
                </section>

                                <!-- Step 5: Review & Submit -->
                <h3>Review & Submit</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">preview</i>
                            Review your event details
                        </div>
                            
                            <div class="review-summary">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">event_note</i> Event Details</h5>
                                        <div class="review-item">
                                            <strong>Title:</strong> <span id="review-title">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Group:</strong> <span id="review-group">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Description:</strong> <span id="review-description">-</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">schedule</i> Schedule</h5>
                                        <div class="review-item">
                                            <strong>Date:</strong> <span id="review-date">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Time:</strong> <span id="review-time">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">place</i> Location</h5>
                                        <div class="review-item">
                                            <strong>Address:</strong> <span id="review-address">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>City:</strong> <span id="review-city">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>State:</strong> <span id="review-state">-</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">settings</i> Settings</h5>
                                        <div class="review-item">
                                            <strong>Capacity:</strong> <span id="review-capacity">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Age Restriction:</strong> <span id="review-age">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Accessibility:</strong> <span id="review-accessibility">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Description Field -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">description</i>
                                Description
                            </label>
                            {{ form.description }}
                        </div>

                        <!-- Agreement Checkboxes -->
                        <div class="mb-4">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h3 class="h5 fw-bold mb-3">Required Agreements</h3>

                                <div class="form-check mb-3">
                                    {{ form.eula_agreement|add_class:'form-check-input' }}
                                    <label class="form-check-label" for="{{ form.eula_agreement.id_for_label }}">
                                        {{ form.eula_agreement.label }}
                                        <a href="{% url 'eula' %}" target="_blank" class="ms-1">
                                            <i class="material-icons" style="font-size: 1rem;">open_in_new</i>
                                        </a>
                                    </label>
                                    {% if form.eula_agreement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.eula_agreement.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-check">
                                    {{ form.state_agreement|add_class:'form-check-input' }}
                                    <label class="form-check-label" for="{{ form.state_agreement.id_for_label }}">
                                        {{ form.state_agreement.label }}
                                    </label>
                                    {% if form.state_agreement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.state_agreement.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                </section>
                    </form>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize address autocomplete
        const addressInput = document.getElementById('{{ form.address.id_for_label }}');
        const stateInput = document.getElementById('{{ form.state.id_for_label }}');
        const cityInput = document.getElementById('{{ form.city.id_for_label }}');
        let searchTimeout;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second between requests
        let userLocation = null;

        // Get user location when page loads
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                },
                (error) => {
                    console.error('Error getting location:', error);
                }
            );
        }

        // Create autocomplete container
        const autocompleteContainer = document.createElement('div');
        autocompleteContainer.className = 'autocomplete-container';
        autocompleteContainer.style.cssText = `
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 4px;
            top: 100%;
        `;
        addressInput.parentElement.style.position = 'relative';
        addressInput.parentElement.appendChild(autocompleteContainer);

        // Handle address input
        addressInput.addEventListener('input', function (e) {
            e.preventDefault(); // Prevent default to avoid URL showing
            clearTimeout(searchTimeout);
            const query = this.value;

            if (query.length < 3) {
                autocompleteContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                const now = Date.now();
                const timeSinceLastRequest = now - lastRequestTime;

                if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                    setTimeout(() => {
                        performSearch(query);
                    }, MIN_REQUEST_INTERVAL - timeSinceLastRequest);
                } else {
                    performSearch(query);
                }
            }, 300);
        });

        // Prevent form submission on enter
        addressInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Add keyboard navigation
        addressInput.addEventListener('keydown', function (e) {
            const suggestions = autocompleteContainer.getElementsByClassName('autocomplete-suggestion');
            const activeSuggestion = autocompleteContainer.querySelector(
                '.autocomplete-suggestion.active');
            let index = Array.from(suggestions).indexOf(activeSuggestion);

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (index < suggestions.length - 1) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index + 1].classList.add('active');
                        suggestions[index + 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (index > 0) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index - 1].classList.add('active');
                        suggestions[index - 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (activeSuggestion) {
                        activeSuggestion.click();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    autocompleteContainer.style.display = 'none';
                    break;
            }
        });

        function performSearch(query) {
            lastRequestTime = Date.now();

            // Get existing city and state values
            const existingCity = cityInput.value.trim();
            const existingState = stateInput.value.trim();

            // Build the search query
            let searchQuery = query;
            if (existingCity && existingState) {
                searchQuery = `${query} ${existingCity} ${existingState}`;
            }

            let searchUrl =
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=us&addressdetails=1&limit=10`;

            // If we have user location, add it to the search to prioritize nearby results
            if (userLocation) {
                searchUrl += `&lat=${userLocation.lat}&lon=${userLocation.lon}&radius=50000`; // 50km radius
            }

            fetch(searchUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'FURsvp/1.0 (https://fursvp.org)',
                        'Referer': window.location.origin
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Geocoding API error:', response.status, response.statusText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    console.log('Search query that failed:', searchQuery);
                    autocompleteContainer.style.display = 'none';
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        autocompleteContainer.style.display = 'none';
                        return;
                    }

                    // Clear existing suggestions
                    autocompleteContainer.innerHTML = '';

                    // Add new suggestions
                    data.forEach(result => {
                        const address = result.address;
                        let streetAddress = '';
                        let fullAddress = '';

                        if (address.road) {
                            streetAddress = address.road;
                            fullAddress = address.road;
                            if (address.house_number) {
                                streetAddress = address.house_number + ' ' + streetAddress;
                                fullAddress = address.house_number + ' ' + fullAddress;
                            }
                            // Add city and state to the full address only
                            if (address.city || address.town || address.village) {
                                fullAddress += ', ' + (address.city || address.town ||
                                    address.village);
                            }
                            if (address.state) {
                                fullAddress += ', ' + address.state;
                            }
                        }

                        if (streetAddress) {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'autocomplete-suggestion';
                            suggestion.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                    `;
                            suggestion.textContent = fullAddress;
                            suggestion.addEventListener('click', () => {
                                // Set only the street address in the address field
                                addressInput.value = streetAddress;
                                // Update city and state fields separately
                                if (address.state) {
                                    stateInput.value = address.state;
                                }
                                if (address.city || address.town || address.village) {
                                    cityInput.value = address.city || address.town ||
                                        address.village;
                                }
                                autocompleteContainer.style.display = 'none';
                            });
                            suggestion.addEventListener('mouseover', () => {
                                // Remove active class from all suggestions
                                Array.from(autocompleteContainer.getElementsByClassName(
                                    'autocomplete-suggestion')).forEach(s => {
                                    s.classList.remove('active');
                                });
                                suggestion.classList.add('active');
                                suggestion.style.backgroundColor = '#f5f5f5';
                            });
                            suggestion.addEventListener('mouseout', () => {
                                suggestion.style.backgroundColor = 'white';
                            });
                            autocompleteContainer.appendChild(suggestion);
                        }
                    });

                    // Add active class to first suggestion
                    const firstSuggestion = autocompleteContainer.querySelector('.autocomplete-suggestion');
                    if (firstSuggestion) {
                        firstSuggestion.classList.add('active');
                    }

                    autocompleteContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching address:', error);
                    autocompleteContainer.style.display = 'none';
                });
        }

        // Handle location button click
        const locationButton = document.getElementById('locationButton');
        locationButton.addEventListener('click', (e) => {
            e.preventDefault();

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            locationButton.disabled = true;
            locationButton.innerHTML = '<i class="material-icons">hourglass_empty</i>';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        // Search for nearby cities instead of exact location
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&addressdetails=1&zoom=10`, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'User-Agent': 'FURsvp/1.0 (https://fursvp.org)',
                                    'Referer': window.location.origin
                                }
                            }
                        );

                        if (!response.ok) {
                            console.error('Reverse geocoding API error:', response.status, response.statusText);
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        if (data && data.address) {
                            // Create a container for nearby cities
                            const nearbyContainer = document.createElement('div');
                            nearbyContainer.className = 'autocomplete-container';
                            nearbyContainer.style.cssText = `
                        position: absolute;
                        width: 100%;
                        max-height: 200px;
                        overflow-y: auto;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        z-index: 1000;
                        margin-top: 4px;
                    `;
                            addressInput.parentElement.appendChild(nearbyContainer);

                            // Add the current location as a suggestion
                            const suggestion = document.createElement('div');
                            suggestion.className = 'autocomplete-suggestion';
                            suggestion.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                    `;
                            suggestion.textContent = data.display_name;
                            suggestion.addEventListener('click', () => {
                                // Set city and state only (ignore county)
                                if (data.address) {
                                    if (data.address.city || data.address.town || data.address.village) {
                                        cityInput.value = data.address.city || data.address.town || data.address.village;
                                    }
                                    if (data.address.state) {
                                        // Set the state dropdown by matching the state name
                                        for (let i = 0; i < stateInput.options.length; i++) {
                                            if (stateInput.options[i].text === data.address.state) {
                                                stateInput.selectedIndex = i;
                                                stateInput.dispatchEvent(new Event('change'));
                                                break;
                                            }
                                        }
                                    }
                                }
                                nearbyContainer.remove();
                            });
                            suggestion.addEventListener('mouseover', () => {
                                suggestion.style.backgroundColor = '#f5f5f5';
                            });
                            suggestion.addEventListener('mouseout', () => {
                                suggestion.style.backgroundColor = 'white';
                            });
                            nearbyContainer.appendChild(suggestion);

                            // Close suggestions when clicking outside
                            document.addEventListener('click', function closeSuggestions(e) {
                                if (!nearbyContainer.contains(e.target) && e.target !==
                                    locationButton) {
                                    nearbyContainer.remove();
                                    document.removeEventListener('click',
                                        closeSuggestions);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching nearby cities:', error);
                        alert('Error getting nearby cities. Please try again.');
                    } finally {
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert(
                        'Error getting your location. Please make sure location services are enabled.'
                        );
                    locationButton.disabled = false;
                    locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                }
        );
    });

    // Initialize Quill.js
    function initQuill() {
        const isDark = document.body.classList.contains('dark-mode');
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        
        if (!descriptionField) return;
        
        // Create Quill container
        const quillContainer = document.createElement('div');
        quillContainer.id = 'quill-editor';
        quillContainer.style.height = '300px';
        descriptionField.parentNode.insertBefore(quillContainer, descriptionField);
        descriptionField.style.display = 'none';
        
        // Initialize Quill
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Describe your event...',
            readOnly: false
        });
        
        // Set initial content if any
        if (descriptionField.value) {
            quill.root.innerHTML = descriptionField.value;
        }
        
        // Sync Quill content with hidden textarea
        quill.on('text-change', function() {
            descriptionField.value = quill.root.innerHTML;
        });
        
        // Dark mode support
        if (isDark) {
            quillContainer.querySelector('.ql-toolbar').style.backgroundColor = '#2d3748';
            quillContainer.querySelector('.ql-toolbar').style.borderColor = '#4a5568';
            quillContainer.querySelector('.ql-container').style.backgroundColor = '#2d3748';
            quillContainer.querySelector('.ql-container').style.borderColor = '#4a5568';
            quillContainer.querySelector('.ql-editor').style.color = '#e2e8f0';
        }
    }

    // Initialize Quill on page load
    initQuill();

    // Initialize Flatpickr
    flatpickr("#{{ form.date.id_for_label }}", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: "true",
            theme: "light",
        allowInput: true,
        altInput: true,
        altFormat: "F j, Y",
        altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
            document.getElementById("{{ form.date.id_for_label }}").value = dateStr;
            },
            onReady: function (selectedDates, dateStr, instance) {
                // Add custom styles to match theme
                const calendar = instance.calendarContainer;
                calendar.style.borderRadius = '8px';
                calendar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                calendar.style.border = '1px solid #dee2e6';

                // Style the selected date
                const selectedDay = calendar.querySelector('.selected');
                if (selectedDay) {
                    selectedDay.style.backgroundColor = '#0d6efd';
                    selectedDay.style.borderColor = '#0d6efd';
                }

                // Style the current day
                const today = calendar.querySelector('.today');
                if (today) {
                    today.style.borderColor = '#0d6efd';
                }
            }
        });

        // Initialize Flatpickr for start_time
        const startTimePicker = flatpickr("#{{ form.start_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.start_time.id_for_label }}").value = dateStr;
                // Update end time min time when start time changes
                if (endTimePicker) {
                    endTimePicker.set('minTime', dateStr);
                    // If end time is before start time, update it
                    const endTime = endTimePicker.selectedDates[0];
                    if (endTime && endTime < selectedDates[0]) {
                        endTimePicker.setDate(selectedDates[0]);
                    }
                }
            }
        });

        // Initialize Flatpickr for end_time
        const endTimePicker = flatpickr("#{{ form.end_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.end_time.id_for_label }}").value = dateStr;
        }
    });

    // RSVP Questions toggle
    var enableRsvpQuestions = document.getElementById('{{ form.enable_rsvp_questions.id_for_label }}');
    var rsvpQuestionsSection = document.getElementById('rsvp-questions-section');
    if (enableRsvpQuestions && rsvpQuestionsSection) {
        enableRsvpQuestions.addEventListener('change', function() {
            rsvpQuestionsSection.style.display = this.checked ? 'block' : 'none';
        });
    }
});
</script>
{% endblock %}