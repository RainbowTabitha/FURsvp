{% extends 'events/base.html' %}
{% block title %}Create Event - FURsvp{% endblock %}
{% load widget_tweaks %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Progress Bar Styles -->
<style>
.progress-container {
    max-width: 800px;
    margin: 0 auto 2rem auto;
    width: 100%;
}

.progress-bar {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    gap: 1rem;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 0;
    text-align: center;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    flex-shrink: 0;
    margin-bottom: 0.5rem;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
    text-align: center;
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* Step states */
.progress-step.completed .step-number {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

.progress-step.current .step-number {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    transform: scale(1.1);
}

.progress-step.pending .step-number {
    background: #f1f5f9;
    color: #94a3b8;
    border-color: #e2e8f0;
}

/* Labels */
.progress-step.completed .step-label {
    color: #10b981;
    font-weight: 600;
}

.progress-step.current .step-label {
    color: #4f46e5;
    font-weight: 600;
}

.progress-step.pending .step-label {
    color: #64748b;
}



/* Animation for step transitions */
@keyframes stepActivate {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1.1);
    }
}

.progress-step.current .step-number {
    animation: stepActivate 0.3s ease;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .progress-bar {
        padding: 1rem;
        gap: 0.5rem;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }
    
    .step-label {
        font-size: 0.75rem;
        display: none;
    }
    
    .progress-step.current .step-label {
        display: block;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        z-index: 10;
    }
}
</style>
<style>
/* Clean, modern styles */
.wizard-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label.required::after {
    content: ' *';
    color: #ef4444;
    font-weight: 700;
}

.form-control, .form-select {
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus, .form-select:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    background: white;
}

/* Reset focus states for flatpickr inputs when not active */
.flatpickr-date:not(:focus):not(.active),
.flatpickr-time:not(:focus):not(.active) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
}

/* Nuclear option - force all flatpickr inputs to have correct border */
input[type="text"].flatpickr-date,
input[type="text"].flatpickr-time {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

input[type="text"].flatpickr-date:focus,
input[type="text"].flatpickr-time:focus {
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
}

/* Flatpickr input field styling */
.flatpickr-date, .flatpickr-time {
    cursor: pointer;
    background: white !important;
    border: 2px solid #e2e8f0 !important;
    transition: all 0.3s ease !important;
}

.flatpickr-date:focus, .flatpickr-time:focus {
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
    background: white !important;
}

/* Force reset all focus states when not active */
.flatpickr-date:not(:focus), .flatpickr-time:not(:focus),
.flatpickr-date:not(.active), .flatpickr-time:not(.active),
.flatpickr-date:not([data-focus]), .flatpickr-time:not([data-focus]) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

/* Override any flatpickr-specific classes */
.flatpickr-input:not(:focus),
.flatpickr-input:not(.active) {
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    outline: none !important;
}

/* Fix z-index and positioning issues */
.flatpickr-calendar {
    z-index: 99999 !important;
    position: absolute !important;
}

.flatpickr-calendar.time {
    z-index: 99999 !important;
}

/* Ensure proper input group alignment */
.input-group .flatpickr-date,
.input-group .flatpickr-time {
    border-left: none !important;
    border-radius: 0 12px 12px 0 !important;
}

.input-group .input-group-text + .flatpickr-date,
.input-group .input-group-text + .flatpickr-time {
    border-left: none !important;
}

.input-group-text {
    background: #f1f5f9;
    border: 2px solid #e2e8f0;
    border-right: none;
    border-radius: 12px 0 0 12px;
    color: #64748b;
}

.input-group .form-control {
    border-left: none;
    border-radius: 0 12px 12px 0;
}

/* Trix Editor Styling */
trix-editor {
    border-radius: 0 0 12px 12px !important;
    border: 2px solid #e2e8f0 !important;
    border-top: none !important;
    background: white !important;
    min-height: 200px !important;
    padding: 1.5rem !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin-top: -20px !important;
    position: relative !important;
    z-index: 1 !important;
}

trix-toolbar {
    border-radius: 12px 12px 0 0 !important;
    border: 2px solid #e2e8f0 !important;
    border-bottom: none !important;
    background: #f8fafc !important;
    padding: 0.75rem !important;
    transform: scale(0.85) !important;
    transform-origin: top left !important;
    width: 117.65% !important;
    margin-bottom: 0 !important;
    position: relative !important;
    z-index: 2 !important;
}

trix-toolbar .trix-button-group {
    border: none !important;
    margin-right: 0.5rem !important;
}

trix-toolbar .trix-button {
    border: none !important;
    background: transparent !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    font-size: 1rem !important;
}

trix-toolbar .trix-button:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button.trix-active {
    background: #4f46e5 !important;
    color: white !important;
}

trix-toolbar .trix-button.trix-active:hover {
    background: #4338ca !important;
}

/* Custom attachment button styling */
trix-toolbar .trix-button--icon-attach {
    background: transparent !important;
    border: none !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
}

/* Fix divider and corner issues */
trix-toolbar .trix-button-group {
    border: none !important;
    margin-right: 0.75rem !important;
}

trix-toolbar .trix-button-group:not(:last-child) {
    border-right: 1px solid #e2e8f0 !important;
    padding-right: 0.75rem !important;
}

/* Ensure proper border radius and no gaps */
trix-toolbar {
    overflow: hidden !important;
}

/* Container styling to eliminate gaps */
trix-editor {
    display: block !important;
}

/* Override any default margins/padding that might cause gaps */
trix-editor:before,
trix-editor:after {
    display: none !important;
}

trix-toolbar .trix-button--icon-attach:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button--icon-attach .trix-button-icon {
    font-size: 1rem !important;
    line-height: 1 !important;
}

/* Ensure bold and italic button icons are visible */
trix-toolbar .trix-button--icon-bold .trix-button-icon,
trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-weight: bold !important;
    font-size: 1rem !important;
    line-height: 1 !important;
    color: #64748b !important;
    display: block !important;
}

trix-toolbar .trix-button--icon-bold .trix-button-icon {
    font-family: serif !important;
}

trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-style: italic !important;
    font-family: serif !important;
}

/* Attachment preview styling */
trix-editor .trix-attachment {
    border-radius: 8px !important;
    border: 1px solid #e2e8f0 !important;
    margin: 0.5rem 0 !important;
    padding: 0.5rem !important;
    background: #f8fafc !important;
}

trix-editor .trix-attachment__caption {
    color: #64748b !important;
    font-size: 0.875rem !important;
    margin-top: 0.25rem !important;
}

.review-summary {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.review-summary h5 {
    color: #1e293b;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.review-item {
    margin-bottom: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-item strong {
    color: #374151;
    font-weight: 600;
}

.review-item span {
    color: #64748b;
}

.agreement-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
}

.agreement-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 1rem;
}

.form-check {
    margin-bottom: 1rem;
}

.form-check-input {
    border-radius: 6px;
    border: 2px solid #e2e8f0;
}

.form-check-input:checked {
    background-color: #4f46e5;
    border-color: #4f46e5;
}

.form-check-label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Hide jQuery Steps Progress Bar */
.wizard > .steps {
    display: none !important;
}

/* Add step numbers */
.wizard > .steps > ul > li a::before {
    content: attr(data-step);
    display: block;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e2e8f0;
    color: #64748b;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.25rem;
}

.wizard > .steps > ul > li a:hover {
    background: #e2e8f0;
    color: #374151;
    transform: translateY(-2px);
}

.wizard > .steps > ul > li.current a {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    transform: translateY(-2px);
}

.wizard > .steps > ul > li.current a::before {
    background: white;
    color: #4f46e5;
}

.wizard > .steps > ul > li.done a {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

.wizard > .steps > ul > li.done a::before {
    background: white;
    color: #10b981;
}

.wizard > .steps > ul > li.error a {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
}

.wizard > .steps > ul > li.error a::before {
    background: white;
    color: #ef4444;
}

.wizard > .steps > ul > li.disabled a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .steps > ul > li.disabled a::before {
    background: #e2e8f0;
    color: #94a3b8;
}

/* Progress line between steps */
.wizard > .steps > ul > li:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 30px;
    right: -0.25rem;
    width: 0.5rem;
    height: 2px;
    background: #e2e8f0;
    z-index: 1;
}

.wizard > .steps > ul > li.done:not(:last-child)::after {
    background: #10b981;
}

.wizard > .steps > ul > li.current:not(:last-child)::after {
    background: linear-gradient(90deg, #10b981 0%, #4f46e5 100%);
}

/* Clean step text and remove redundant labels */
.wizard > .steps > ul > li a {
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.875rem;
    font-weight: 500;
}

/* Remove the "current step:" text completely */
.wizard > .steps > ul > li a::before {
    display: none !important;
}

/* Override any default text content */
.wizard > .steps > ul > li a {
    content: none !important;
}

/* Let jQuery Steps handle the visibility */
.wizard > .content > .body > section {
    /* Let the library handle this */
}

/* Hide the specific step headers */
#event-form-h-0,
#event-form-h-1,
#event-form-h-2,
#event-form-h-3,
#event-form-h-4,
#event-form-h-5 {
    display: none !important;
}

.wizard > .content {
    display: block;
    margin: 0;
    min-height: 500px;
    overflow: hidden;
    position: relative;
    width: auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.wizard > .content > .body {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 2rem;
    overflow: hidden;
}

.wizard > .content > .body ul {
    list-style: disc !important;
}

.wizard > .content > .body li {
    display: list-item;
}

.wizard > .content > .body blockquote {
    border-left: 3px solid #ccc;
    margin: 0;
    padding-left: 1em;
}

.wizard > .content > .body code {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
}

.wizard > .actions {
    position: relative;
    display: block;
    text-align: right;
    width: 100%;
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.wizard > .actions > ul {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 0;
    margin: 0;
}

.wizard > .actions > ul > li {
    display: inline-block;
}

.wizard > .actions a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    font-size: 1rem;
}

.wizard > .actions .disabled a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .actions .disabled a:hover {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .actions .disabled a:active {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .loading {
}

.wizard > .loading a {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: default;
}

.wizard > .loading a:hover {
    background: #f1f5f9;
    color: #94a3b8;
}

.wizard > .loading a:active {
    background: #f1f5f9;
    color: #94a3b8;
}

/* Flatpickr Theming */
.flatpickr-calendar {
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    padding: 0.5rem;
    width: auto;
    min-width: 280px;
    max-width: 320px;
    z-index: 9999;
}

.flatpickr-calendar.open {
    animation: flatpickr-fadeIn 0.3s ease-out;
}

@keyframes flatpickr-fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.flatpickr-months {
    background: #4f46e5;
    border-radius: 8px 8px 0 0;
    color: white;
    padding: 0.75rem;
    margin: -0.5rem -0.5rem 0.5rem -0.5rem;
}

.flatpickr-month {
    color: white;
    font-weight: 600;
}

.flatpickr-current-month {
    color: white;
    font-weight: 600;
}

.flatpickr-monthDropdown-months {
    background: transparent;
    color: white;
    border: none;
    font-weight: 600;
}

.flatpickr-monthDropdown-months option {
    background: white;
    color: #374151;
}

.flatpickr-weekdays {
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.flatpickr-weekday {
    color: #64748b;
    font-weight: 600;
    font-size: 0.875rem;
}

.flatpickr-days {
    background: white;
    border-radius: 8px;
}

.flatpickr-day {
    border-radius: 8px;
    margin: 2px;
    color: #374151;
    font-weight: 500;
    transition: all 0.2s ease;
}

.flatpickr-day:hover {
    background: #e2e8f0;
    color: #374151;
}

.flatpickr-day.selected {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

.flatpickr-day.selected:hover {
    background: #4338ca;
    color: white;
}

.flatpickr-day.today {
    background: #f1f5f9;
    color: #4f46e5;
    border-color: #4f46e5;
}

.flatpickr-day.today:hover {
    background: #e2e8f0;
    color: #4f46e5;
}

.flatpickr-day.disabled {
    color: #cbd5e1;
    background: transparent;
}

.flatpickr-day.disabled:hover {
    background: transparent;
    color: #cbd5e1;
}

.flatpickr-time {
    background: #f8fafc;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #e2e8f0;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.flatpickr-time input {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 16px;
    color: #374151;
    font-weight: 600;
    text-align: center;
    width: 80px;
    min-width: 80px;
    height: 50px;
    line-height: 1;
}

.flatpickr-time input:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    outline: none;
}

.flatpickr-time .flatpickr-am-pm {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    color: #374151;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 60px;
    text-align: center;
    height: 50px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.flatpickr-time .flatpickr-am-pm:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
}

.flatpickr-time .flatpickr-am-pm.selected {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

.flatpickr-time .flatpickr-am-pm.selected:hover {
    background: #4338ca;
    border-color: #4338ca;
}

/* Fix time picker positioning and sizing */
.flatpickr-calendar.time {
    width: auto;
    min-width: 250px;
    max-width: 350px;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    margin-top: 4px !important;
}

.flatpickr-time .numInputWrapper {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.flatpickr-time .numInputWrapper input {
    margin: 0;
}

/* Ensure proper spacing in time picker */
.flatpickr-time .flatpickr-time-separator {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0 0.25rem;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .form-card {
        padding: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
    }
    
    .wizard > .steps > ul > li a {
        margin: 0 0.25em 0.25em 0.25em;
        padding: 0.75rem;
        font-size: 0.875rem;
    }
    
    .wizard > .actions a {
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
    }
    
    .flatpickr-calendar {
        font-size: 12px;
        min-width: 250px;
        max-width: 280px;
    }
    
    .flatpickr-day {
        margin: 1px;
    }
    
    .flatpickr-time {
        padding: 0.75rem;
        gap: 0.25rem;
    }
    
    .flatpickr-time input {
        width: 70px;
        min-width: 70px;
        font-size: 14px;
        padding: 0.5rem;
        height: 45px;
    }
    
    .flatpickr-time .flatpickr-am-pm {
        min-width: 40px;
        padding: 0.5rem 0.75rem;
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="create-event-page">
    <div class="container">
        <!-- Breadcrumbs -->
        <div class="py-3">
            <nav class="modern-breadcrumbs">
                <a href="{% url 'home' %}">
                    <span class="material-icons">home</span>
                    Home
                </a>
                <span class="breadcrumb-chevron">›</span>
                <a href="{% url 'event_index' %}">
                    <span class="material-icons">event</span>
                    Events
                </a>
                <span class="breadcrumb-chevron">›</span>
                <span class="breadcrumb-current">
                    <span class="material-icons">add_circle</span>
                    Create Event
                </span>
            </nav>
        </div>

        <!-- Page Header -->
        <div class="page-header-modern">
            <h1 class="page-title-modern">
                <span class="material-icons">add_circle</span>
                Create New Event
            </h1>
            <p class="page-subtitle">Let's create your event step by step</p>
        </div>
        
        <div class="wizard-container">
            <!-- Horizontal Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-step" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Basic Information</div>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Schedule</div>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Location</div>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Settings</div>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-number">5</div>
                        <div class="step-label">Review & Submit</div>
                    </div>
                </div>
            </div>
            
            <form method="post" class="needs-validation" novalidate id="event-form">
                {% csrf_token %}
                
                                <!-- Step 1: Basic Information -->
                <h3>Basic Information</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">event_note</i>
                            Let's start with the basics
                        </div>
                            
                            <!-- Title Field -->
                            <div class="mb-4">
                                                            <label for="{{ form.title.id_for_label }}" class="form-label required">
                                <i class="material-icons">edit</i>
                                What's the name of your event?
                            </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    {{ form.title|add_class:'form-control'|attr:'placeholder:Enter event title' }}
                                </div>
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Group Field -->
                            <div class="mb-4">
                                                            <label for="{{ form.group.id_for_label }}" class="form-label required">
                                <i class="material-icons">groups</i>
                                Which group is hosting this event?
                            </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">groups</i>
                                    </span>
                                    {{ form.group|add_class:'form-select' }}
                                </div>
                                {% if form.group.help_text %}
                                    <div class="form-text text-muted">{{ form.group.help_text }}</div>
                                {% endif %}
                                {% if form.group.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.group.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Description Field -->
                            <div class="mb-4">
                                                                                        <label for="{{ form.description.id_for_label }}" class="form-label required">
                                <i class="material-icons">description</i>
                                Tell us about your event
                            </label>
                            <input type="hidden" id="{{ form.description.id_for_label }}" name="{{ form.description.name }}">
                            <trix-editor input="{{ form.description.id_for_label }}" placeholder="Describe your event in detail..."></trix-editor>
                            <div class="form-text text-muted">Describe what attendees can expect at your event.</div>
                            </div>
                        </div>
                </section>

                                <!-- Step 2: Schedule -->
                <h3>Schedule</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">schedule</i>
                            When is your event happening?
                        </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.date.id_for_label }}" class="form-label required">
                                        <i class="material-icons">event</i>
                                        What date is your event?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">event</i>
                                        </span>
                                        {{ form.date|add_class:'form-control flatpickr-date'|attr:'placeholder:Select date'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label required">
                                        <i class="material-icons">schedule</i>
                                        What time does it start?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">schedule</i>
                                        </span>
                                        {{ form.start_time|add_class:'form-control flatpickr-time'|attr:'placeholder:Start time'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label required">
                                        <i class="material-icons">schedule</i>
                                        What time does it end?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">schedule</i>
                                        </span>
                                        {{ form.end_time|add_class:'form-control flatpickr-time'|attr:'placeholder:End time'|attr:'data-input'|attr:'required' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                </section>

                                <!-- Step 3: Location -->
                <h3>Location</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">place</i>
                            Where is your event taking place?
                        </div>
                            
                            <!-- Current Location Button -->
                            <div class="mb-4">
                                <button type="button" id="useCurrentLocation" class="btn btn-outline-primary">
                                    <i class="material-icons">my_location</i>
                                    Use Current Location
                                </button>
                                <div id="locationStatus" class="mt-2" style="display: none;">
                                    <div class="alert alert-info" role="alert">
                                        <i class="material-icons">location_searching</i>
                                        Getting your location...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label required">
                                    <i class="material-icons">place</i>
                                    What's the street address?
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="material-icons">place</i>
                                    </span>
                                    {{ form.address|add_class:'form-control'|attr:'placeholder:Street address'|attr:'required'|attr:'autocomplete:off' }}
                                </div>
                                <!-- Street Address Autocomplete Dropdown -->
                                <div id="addressAutocomplete" class="autocomplete-dropdown" style="display: none;">
                                    <ul class="list-group" id="addressSuggestions"></ul>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label required">
                                        <i class="material-icons">location_city</i>
                                        Which city?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">location_city</i>
                                        </span>
                                        {{ form.city|add_class:'form-control'|attr:'placeholder:City'|attr:'required' }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_state" class="form-label required">
                                        <i class="material-icons">map</i>
                                        Which state?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">map</i>
                                        </span>
                                        <select name="state" id="id_state" class="form-select" required>
                                            <option value="">Select State</option>
                                            <option value="Alabama">Alabama</option>
                                            <option value="Alaska">Alaska</option>
                                            <option value="Arizona">Arizona</option>
                                            <option value="Arkansas">Arkansas</option>
                                            <option value="California">California</option>
                                            <option value="Colorado">Colorado</option>
                                            <option value="Connecticut">Connecticut</option>
                                            <option value="Delaware">Delaware</option>
                                            <option value="Florida">Florida</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Hawaii">Hawaii</option>
                                            <option value="Idaho">Idaho</option>
                                            <option value="Illinois">Illinois</option>
                                            <option value="Indiana">Indiana</option>
                                            <option value="Iowa">Iowa</option>
                                            <option value="Kansas">Kansas</option>
                                            <option value="Kentucky">Kentucky</option>
                                            <option value="Louisiana">Louisiana</option>
                                            <option value="Maine">Maine</option>
                                            <option value="Maryland">Maryland</option>
                                            <option value="Massachusetts">Massachusetts</option>
                                            <option value="Michigan">Michigan</option>
                                            <option value="Minnesota">Minnesota</option>
                                            <option value="Mississippi">Mississippi</option>
                                            <option value="Missouri">Missouri</option>
                                            <option value="Montana">Montana</option>
                                            <option value="Nebraska">Nebraska</option>
                                            <option value="Nevada">Nevada</option>
                                            <option value="New Hampshire">New Hampshire</option>
                                            <option value="New Jersey">New Jersey</option>
                                            <option value="New Mexico">New Mexico</option>
                                            <option value="New York">New York</option>
                                            <option value="North Carolina">North Carolina</option>
                                            <option value="North Dakota">North Dakota</option>
                                            <option value="Ohio">Ohio</option>
                                            <option value="Oklahoma">Oklahoma</option>
                                            <option value="Oregon">Oregon</option>
                                            <option value="Pennsylvania">Pennsylvania</option>
                                            <option value="Rhode Island">Rhode Island</option>
                                            <option value="South Carolina">South Carolina</option>
                                            <option value="South Dakota">South Dakota</option>
                                            <option value="Tennessee">Tennessee</option>
                                            <option value="Texas">Texas</option>
                                            <option value="Utah">Utah</option>
                                            <option value="Vermont">Vermont</option>
                                            <option value="Virginia">Virginia</option>
                                            <option value="Washington">Washington</option>
                                            <option value="West Virginia">West Virginia</option>
                                            <option value="Wisconsin">Wisconsin</option>
                                            <option value="Wyoming">Wyoming</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                </section>

<style>
/* Autocomplete Dropdown Styles */
.autocomplete-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    margin-top: -1px;
}

.autocomplete-dropdown .list-group {
    margin: 0;
    border: none;
}

.autocomplete-dropdown .list-group-item {
    border: none;
    border-bottom: 1px solid #f0f0f0;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.autocomplete-dropdown .list-group-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-dropdown .list-group-item:last-child {
    border-bottom: none;
}

.autocomplete-dropdown .list-group-item .address-main {
    font-weight: 600;
    color: #333;
}

.autocomplete-dropdown .list-group-item .address-secondary {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Location Status Styles */
#locationStatus .alert {
    border-radius: 0.5rem;
    border: none;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1976d2;
}

#locationStatus .alert i {
    margin-right: 0.5rem;
}

/* Current Location Button Styles */
#useCurrentLocation {
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid #007bff;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: #007bff;
}

#useCurrentLocation:hover {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

#useCurrentLocation:active {
    transform: translateY(0);
}

#useCurrentLocation i {
    margin-right: 0.5rem;
}

/* Dark mode support */
.dark-mode .autocomplete-dropdown {
    background: #2d3748;
    border-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item {
    background: #2d3748;
    color: #e2e8f0;
    border-bottom-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item:hover {
    background-color: #4a5568;
}

.dark-mode .autocomplete-dropdown .list-group-item .address-main {
    color: #f7fafc;
}

.dark-mode .autocomplete-dropdown .list-group-item .address-secondary {
    color: #a0aec0;
}
</style>

                                <!-- Step 4: Settings -->
                <h3>Settings</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">settings</i>
                            Let's configure your event settings
                        </div>
                            
                            <!-- Capacity and Restrictions -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.age_restriction.id_for_label }}" class="form-label">
                                        <i class="material-icons">block</i>
                                        Is there an age restriction?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">block</i>
                                        </span>
                                        {{ form.age_restriction|add_class:'form-select' }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.capacity.id_for_label }}" class="form-label">
                                        <i class="material-icons">people_alt</i>
                                        How many people can attend?
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="material-icons">people_alt</i>
                                        </span>
                                        {{ form.capacity|add_class:'form-control'|attr:'placeholder:Enter event capacity (optional)' }}
                                    </div>
                                    <div class="form-text text-muted">Leave blank for unlimited capacity.</div>
                                    {% if form.capacity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.capacity.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Privacy Settings -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.waitlist_enabled|add_class:'form-check-input' }}
                                        <label class="form-check-label" for="{{ form.waitlist_enabled.id_for_label }}">
                                            <i class="material-icons">queue</i>
                                            Enable waitlist when full?
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.attendee_list_public|add_class:'form-check-input' }}
                                        <label class="form-check-label" for="{{ form.attendee_list_public.id_for_label }}">
                                            <i class="material-icons">visibility</i>
                                            Show attendee list publicly?
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Accessibility -->
                            <div class="mb-3">
                                <label for="{{ form.accessibility_details.id_for_label }}" class="form-label">
                                    <i class="material-icons">accessible</i>
                                    Is your venue accessible?
                                </label>
                                {{ form.accessibility_details|add_class:'form-control'|attr:'rows:3'|attr:'placeholder:Describe accessibility features (leave blank if not accessible)' }}
                                <div class="form-text text-muted">Tell us about wheelchair access, parking, etc.</div>
                            </div>
                        </div>
                </section>

                                <!-- Step 5: Review & Submit -->
                <h3>Review & Submit</h3>
                <section>
                    <div class="form-card">
                        <div class="section-title">
                            <i class="material-icons">preview</i>
                            Review your event details
                        </div>
                            
                            <div class="review-summary">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">event_note</i> Event Details</h5>
                                        <div class="review-item">
                                            <strong>Title:</strong> <span id="review-title">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Group:</strong> <span id="review-group">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Description:</strong> <span id="review-description">-</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">schedule</i> Schedule</h5>
                                        <div class="review-item">
                                            <strong>Date:</strong> <span id="review-date">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Time:</strong> <span id="review-time">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">place</i> Location</h5>
                                        <div class="review-item">
                                            <strong>Address:</strong> <span id="review-address">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>City:</strong> <span id="review-city">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>State:</strong> <span id="review-state">-</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="material-icons">settings</i> Settings</h5>
                                        <div class="review-item">
                                            <strong>Capacity:</strong> <span id="review-capacity">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Age Restriction:</strong> <span id="review-age">-</span>
                                        </div>
                                        <div class="review-item">
                                            <strong>Accessibility:</strong> <span id="review-accessibility">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden form fields for submission -->
                            <div style="display: none;" >

                            </div>

                            <!-- Agreements Section -->
                            <div class="agreement-card mt-4" id="agreements-section">
                                <h3 class="agreement-title">
                                    <i class="material-icons">gavel</i>
                                    Required Agreements
                                </h3>

                                <div class="form-check mb-3">
                                    {{ form.eula_agreement|add_class:'form-check-input' }}
                                    <label class="form-check-label" for="{{ form.eula_agreement.id_for_label }}">
                                        {{ form.eula_agreement.label }}
                                        <a href="{% url 'eula' %}" target="_blank" class="ms-1">
                                            <i class="material-icons" style="font-size: 1rem;">open_in_new</i>
                                        </a>
                                    </label>
                                    {% if form.eula_agreement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.eula_agreement.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-check">
                                    {{ form.state_agreement|add_class:'form-check-input' }}
                                    <label class="form-check-label" for="{{ form.state_agreement.id_for_label }}">
                                        {{ form.state_agreement.label }}
                                    </label>
                                    {% if form.state_agreement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.state_agreement.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                </section>
                    </form>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.js"></script>
<script>
$(document).ready(function() {
    console.log('jQuery loaded:', typeof $ !== 'undefined');
    console.log('jQuery Steps loaded:', typeof $.fn.steps !== 'undefined');
    console.log('Form found:', $("#event-form").length);
    console.log('Form HTML:', $("#event-form").html().substring(0, 200));
    
    // Initialize progress bar
    updateProgressBar(1);
    
    // Try to initialize flatpickr immediately if available
    if (typeof flatpickr !== 'undefined') {
        console.log('Flatpickr available on document ready, initializing...');
        initializeFlatpickr();
    } else {
        console.log('Flatpickr not yet available, will try later...');
    }
    
    // Initialize Flatpickr for date and time fields
    function initializeFlatpickr() {
        console.log('Initializing Flatpickr...');
        
        // Date picker
        const dateInput = document.querySelector('.flatpickr-date');
        console.log('Date input found:', dateInput);
        if (dateInput) {
            try {
                const datePicker = flatpickr(dateInput, {
                    dateFormat: "m/d/Y",
                    allowInput: true,
                    clickOpens: true,
                    disableMobile: false,
                    locale: {
                        firstDayOfWeek: 0
                    },
                                    onChange: function(selectedDates, dateStr, instance) {
                    console.log('Date selected:', dateStr);
                    updateReviewSummary();
                },
                onClose: function(selectedDates, dateStr, instance) {
                    // Force clear focus state
                    setTimeout(() => {
                        instance.input.blur();
                        instance.input.style.borderColor = '#e2e8f0';
                        instance.input.style.boxShadow = 'none';
                    }, 100);
                }
                });
                console.log('Date picker initialized:', datePicker);
            } catch (error) {
                console.error('Error initializing date picker:', error);
            }
        }
        
        // Time pickers
        const timeInputs = document.querySelectorAll('.flatpickr-time');
        console.log('Time inputs found:', timeInputs.length);
        timeInputs.forEach((input, index) => {
            try {
                const timePicker = flatpickr(input, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K", // 12-hour format with AM/PM
                    time_24hr: false,
                    allowInput: true,
                    clickOpens: true,
                    disableMobile: false,
                    onChange: function(selectedDates, dateStr, instance) {
                        console.log('Time selected:', dateStr);
                        updateReviewSummary();
                    },
                    onClose: function(selectedDates, dateStr, instance) {
                        // Force clear focus state
                        setTimeout(() => {
                            instance.input.blur();
                            instance.input.style.borderColor = '#e2e8f0';
                            instance.input.style.boxShadow = 'none';
                        }, 100);
                    }
                });
                console.log(`Time picker ${index + 1} initialized:`, timePicker);
            } catch (error) {
                console.error(`Error initializing time picker ${index + 1}:`, error);
            }
        });
    }
    
    // Wait a moment for everything to load
    setTimeout(function() {
        try {
            // Check if flatpickr is loaded
            if (typeof flatpickr === 'undefined') {
                console.error('Flatpickr is not loaded!');
                return;
            }
            console.log('Flatpickr is available:', typeof flatpickr);
            
            // Initialize flatpickr
            initializeFlatpickr();
            
            // Initialize jQuery Steps wizard
            $("#event-form").steps({
                headerTag: "h3",
                bodyTag: "section",
                transitionEffect: "slideLeft",
                autoFocus: true,
                enableFinishButton: true,
                enablePagination: true,
                enableAllSteps: false,
                showFinishButtonAlways: false,
                finishButtonText: "Create Event",
                nextButtonText: "Next",
                previousButtonText: "Previous",
                onStepChanging: function (event, currentIndex, newIndex) {
                    console.log('Step changing from', currentIndex, 'to', newIndex);
                    
                    // Sync form fields before any step change
                    if (typeof syncFormFields === 'function') {
                        syncFormFields();
                    }
                    
                    // Always allow going back
                    if (currentIndex > newIndex) {
                        return true;
                    }
                    
                    // Validate each step before proceeding
                    if (currentIndex === 0 && newIndex === 1) {
                        // Step 1 validation (Basic Information)
                        var title = $('#{{ form.title.id_for_label }}').val().trim();
                        var group = $('#{{ form.group.id_for_label }}').val();
                        var description = $('#{{ form.description.id_for_label }}').val().trim();
                        
                        var isValid = true;
                        var errorMessage = '';
                        
                        if (!title) {
                            isValid = false;
                            errorMessage += 'Event title is required.\n';
                        }
                        
                        if (!group) {
                            isValid = false;
                            errorMessage += 'Please select a group.\n';
                        }
                        
                        if (!description) {
                            isValid = false;
                            errorMessage += 'Event description is required.\n';
                        }
                        
                        if (!isValid) {
                            alert('Please fill out all required fields:\n' + errorMessage);
                            return false;
                        }
                    } else if (currentIndex === 1 && newIndex === 2) {
                        // Step 2 validation (Date & Time)
                        var date = $('#{{ form.date.id_for_label }}').val().trim();
                        var startTime = $('#{{ form.start_time.id_for_label }}').val().trim();
                        var endTime = $('#{{ form.end_time.id_for_label }}').val().trim();
                        
                        var isValid = true;
                        var errorMessage = '';
                        
                        if (!date) {
                            isValid = false;
                            errorMessage += 'Event date is required.\n';
                        }
                        
                        if (!startTime) {
                            isValid = false;
                            errorMessage += 'Start time is required.\n';
                        }
                        
                        if (!endTime) {
                            isValid = false;
                            errorMessage += 'End time is required.\n';
                        }
                        
                        if (!isValid) {
                            alert('Please fill out all required fields:\n' + errorMessage);
                            return false;
                        }
                    } else if (currentIndex === 2 && newIndex === 3) {
                        // Step 3 validation (Location)
                        var address = $('#{{ form.address.id_for_label }}').val().trim();
                        var city = $('#{{ form.city.id_for_label }}').val().trim();
                        var state = $('#{{ form.state.id_for_label }}').val();
                        
                        var isValid = true;
                        var errorMessage = '';
                        
                        if (!address) {
                            isValid = false;
                            errorMessage += 'Address is required.\n';
                        }
                        
                        if (!city) {
                            isValid = false;
                            errorMessage += 'City is required.\n';
                        }
                        
                        if (!state) {
                            isValid = false;
                            errorMessage += 'State is required.\n';
                        }
                        
                        if (!isValid) {
                            alert('Please fill out all required fields:\n' + errorMessage);
                            return false;
                        }
                    } else if (currentIndex === 3 && newIndex === 4) {
                        // Step 4 validation (Additional Details)
                        var ageRestriction = $('#{{ form.age_restriction.id_for_label }}').val();
                        
                        var isValid = true;
                        var errorMessage = '';
                        
                        if (!ageRestriction) {
                            isValid = false;
                            errorMessage += 'Age restriction is required.\n';
                        }
                        
                        if (!isValid) {
                            alert('Please fill out all required fields:\n' + errorMessage);
                            return false;
                        }
                    }
                    
                    // Allow going forward if validation passes
                    return true;
                },
                onStepChanged: function (event, currentIndex, priorIndex) {
                    console.log('Step changed to', currentIndex);
                    
                    // Sync form fields after step change to ensure data is preserved
                    if (typeof syncFormFields === 'function') {
                        syncFormFields();
                    }
                    
                    // Update progress bar
                    updateProgressBar(currentIndex + 1);
                    
                    // Show agreements section only on review step
                    const agreementsSection = document.getElementById('agreements-section');
                    if (agreementsSection) {
                        if (currentIndex === 4) { // Review step (0-indexed)
                            agreementsSection.style.display = 'block';
                            updateReviewSummary();
                        } else {
                            agreementsSection.style.display = 'none';
                        }
                    }
                },
                onFinishing: function (event, currentIndex) {
                    console.log('Finishing wizard - step:', currentIndex);
                    
                    try {
                        // Sync visible form fields with hidden ones before submission
                        if (typeof syncFormFields === 'function') {
                            syncFormFields();
                        }
                        
                        // Validate checkboxes before submission
                        var eulaAgreement = $('#{{ form.eula_agreement.id_for_label }}').is(':checked');
                        var stateAgreement = $('#{{ form.state_agreement.id_for_label }}').is(':checked');
                        
                        var isValid = true;
                        var errorMessage = '';
                        
                        if (!eulaAgreement) {
                            isValid = false;
                            errorMessage += 'You must agree to the End User License Agreement (EULA).\n';
                        }
                        
                        if (!stateAgreement) {
                            isValid = false;
                            errorMessage += 'You must confirm that all event details are accurate and truthful.\n';
                        }
                        
                        if (!isValid) {
                            alert('Please complete all required agreements:\n' + errorMessage);
                            return false;
                        }
                        
                        // Update review summary before submission
                        if (typeof updateReviewSummary === 'function') {
                            updateReviewSummary();
                        }
                        
                        console.log('Form validation passed, proceeding with submission');
                        return true;
                    } catch (error) {
                        console.error('Error in onFinishing:', error);
                        // Don't show alert, just log the error and continue
                        console.log('Continuing with form submission despite error');
                        return true;
                    }
                },
                onFinished: function (event, currentIndex) {
                    console.log('Wizard finished, submitting form');
                    
                    try {
                        // Final sync of all form fields before submission
                        if (typeof syncFormFields === 'function') {
                            syncFormFields();
                        }
                        
                        // Show loading state
                        var finishButton = $('.wizard .actions a[href="#finish"]');
                        if (finishButton.length > 0) {
                            var originalText = finishButton.text();
                            finishButton.text('Creating Event...').prop('disabled', true);
                        }
                        
                        // Submit the form
                        var form = $(this);
                        console.log('Submitting form:', form);
                        
                        // Submit immediately
                        form.submit();
                        
                    } catch (error) {
                        console.error('Error submitting form:', error);
                        if (finishButton && finishButton.length > 0) {
                            finishButton.text(originalText).prop('disabled', false);
                        }
                        alert('There was an error submitting the form. Please try again.');
                    }
                }
            });
            
            console.log('Wizard initialized successfully');
            console.log('Wizard structure created:', $('.wizard').length);
            console.log('Steps found:', $('.wizard .steps').length);
            console.log('Content found:', $('.wizard .content').length);
            console.log('Actions found:', $('.wizard .actions').length);
            
            // Clean up step text
            $('.wizard .steps ul li a').each(function() {
                var $this = $(this);
                var text = $this.text();
                
                // Remove "current step:" prefix
                text = text.replace(/current step:\s*/i, '');
                
                // Clean up step formatting
                text = text.replace(/^\d+\.\s*/, ''); // Remove "1. " prefix
                
                $this.text(text);
            });
            
            // Initialize flatpickr after wizard is ready
            setTimeout(function() {
                if (typeof flatpickr !== 'undefined') {
                    console.log('Initializing flatpickr after wizard setup...');
                    initializeFlatpickr();
                } else {
                    console.error('Flatpickr still not available after wizard setup');
                }
            }, 500);
        } catch (error) {
            console.error('Error initializing wizard:', error);
        }
    }, 100);
    
        // Initialize Trix Editor
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const trixEditor = document.querySelector('trix-editor');
    
    if (descriptionField && trixEditor) {
        console.log('Trix editor found:', trixEditor);
        
        // Trix automatically handles the connection between the hidden input and the editor
        // We just need to ensure the form validation works properly
        trixEditor.addEventListener('trix-change', function() {
            console.log('Trix content changed');
            // The hidden input is automatically updated by Trix
        });
        
        trixEditor.addEventListener('trix-initialize', function() {
            console.log('Trix editor initialized');
        });
    } else {
        console.error('Trix editor not found');
    }
    
    // Add event listeners for form field changes
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        field.addEventListener('change', updateReviewSummary);
        field.addEventListener('input', updateReviewSummary);
    });
    
    // Configure Trix for image/file attachments
    if (typeof Trix !== 'undefined') {
        // Allow file attachments (images, documents, etc.)
        Trix.config.attachments.preview.caption = {
            name: false,
            size: false
        };
        
        // Configure accepted file types
        Trix.config.attachments.accept = [
            'image/*',
            'application/pdf',
            'text/plain',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        ];
        
        // Set maximum file size (5MB)
        Trix.config.attachments.maxFileSize = 5 * 1024 * 1024;
        
        // Add custom image insertion functionality and reorder toolbar
        document.addEventListener('trix-initialize', function(event) {
            const toolbar = event.target.toolbarElement;
            
            // Remove unnecessary buttons
            const buttonsToRemove = [
                '[data-trix-attribute="href"]', // Link button
                '[data-trix-attribute="quote"]', // Quote button
                '[data-trix-attribute="code"]', // Code button
                '[data-trix-action="outdent"]', // Outdent button
                '[data-trix-action="indent"]'   // Indent button
            ];
            
            buttonsToRemove.forEach(selector => {
                const button = toolbar.querySelector(selector);
                if (button) {
                    button.remove();
                }
            });
            
            // Create image button
            const imageButton = document.createElement('button');
            imageButton.type = 'button';
            imageButton.className = 'trix-button trix-button--icon trix-button--icon-attach';
            imageButton.setAttribute('data-trix-attribute', 'href');
            imageButton.setAttribute('data-trix-action', 'attachFiles');
            imageButton.title = 'Insert images and files';
            imageButton.innerHTML = '<span class="trix-button-icon">🖼️</span>';
            
            // Create file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            fileInput.style.display = 'none';
            
            // Add click handler
            imageButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', function() {
                const files = Array.from(this.files);
                const editor = event.target;
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const attachment = new Trix.Attachment({
                            file: file,
                            url: e.target.result
                        });
                        editor.insertAttachment(attachment);
                    };
                    reader.readAsDataURL(file);
                });
                
                this.value = '';
            });
            
            // Remove any existing attachment buttons to avoid duplicates
            const existingAttachButtons = toolbar.querySelectorAll('[data-trix-action="attachFiles"]');
            existingAttachButtons.forEach(button => {
                if (button !== imageButton) {
                    button.remove();
                }
            });
            
            // Reorder toolbar with logical grouping: Formatting, Structure, Actions
            const buttonGroups = toolbar.querySelectorAll('.trix-button-group');
            if (buttonGroups.length >= 2) {
                const firstGroup = buttonGroups[0];
                
                // Clear first group and add text formatting buttons first
                firstGroup.innerHTML = '';
                
                // Add text formatting buttons to first group
                const boldButton = toolbar.querySelector('[data-trix-attribute="bold"]');
                const italicButton = toolbar.querySelector('[data-trix-attribute="italic"]');
                
                // Create bold button if it doesn't exist
                if (!boldButton) {
                    const newBoldButton = document.createElement('button');
                    newBoldButton.type = 'button';
                    newBoldButton.className = 'trix-button trix-button--icon trix-button--icon-bold';
                    newBoldButton.setAttribute('data-trix-attribute', 'bold');
                    newBoldButton.setAttribute('data-trix-key', 'b');
                    newBoldButton.title = 'Bold';
                    newBoldButton.innerHTML = '<span class="trix-button-icon">B</span>';
                    firstGroup.appendChild(newBoldButton);
                } else {
                    firstGroup.appendChild(boldButton);
                }
                
                // Create italic button if it doesn't exist
                if (!italicButton) {
                    const newItalicButton = document.createElement('button');
                    newItalicButton.type = 'button';
                    newItalicButton.className = 'trix-button trix-button--icon trix-button--icon-italic';
                    newItalicButton.setAttribute('data-trix-attribute', 'italic');
                    newItalicButton.setAttribute('data-trix-key', 'i');
                    newItalicButton.title = 'Italic';
                    newItalicButton.innerHTML = '<span class="trix-button-icon">I</span>';
                    firstGroup.appendChild(newItalicButton);
                } else {
                    firstGroup.appendChild(italicButton);
                }
                
                // Add image button as the 3rd item
                firstGroup.appendChild(imageButton);
                
                // Add event handlers for formatting buttons
                const formatButtons = firstGroup.querySelectorAll('[data-trix-attribute]');
                formatButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const attribute = this.getAttribute('data-trix-attribute');
                        const editor = event.target;
                        
                        if (attribute === 'bold') {
                            editor.activateAttribute('bold');
                        } else if (attribute === 'italic') {
                            editor.activateAttribute('italic');
                        }
                    });
                });
                
                // Add list buttons to second group
                const secondGroup = buttonGroups[1];
                const bulletListButton = toolbar.querySelector('[data-trix-attribute="bullet"]');
                const numberListButton = toolbar.querySelector('[data-trix-attribute="number"]');
                
                if (bulletListButton) secondGroup.appendChild(bulletListButton);
                if (numberListButton) secondGroup.appendChild(numberListButton);
                
                // Move undo/redo to the last group (actions)
                const undoRedoGroup = toolbar.querySelector('.trix-button-group:last-child');
                if (undoRedoGroup) {
                    const undoButton = toolbar.querySelector('[data-trix-action="undo"]');
                    const redoButton = toolbar.querySelector('[data-trix-action="redo"]');
                    
                    if (undoButton) undoRedoGroup.appendChild(undoButton);
                    if (redoButton) undoRedoGroup.appendChild(redoButton);
                }
            }
            
            // Add the file input to the document
            document.body.appendChild(fileInput);
        });
        
        console.log('Trix configured for file attachments with custom image button');
    }
});

function updateProgressBar(currentStep) {
    const steps = document.querySelectorAll('.progress-step');
    
    steps.forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('completed', 'current', 'pending');
        
        if (stepNumber < currentStep) {
            step.classList.add('completed');
        } else if (stepNumber === currentStep) {
            step.classList.add('current');
        } else {
            step.classList.add('pending');
        }
    });
}

function updateReviewSummary() {
    try {
        // Helper function to safely parse HTML content
        function safeParseHTML(htmlContent) {
            if (!htmlContent) return '-';
            
            // Create a temporary div to parse HTML safely
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Remove any script tags for security
            const scripts = tempDiv.querySelectorAll('script');
            scripts.forEach(script => script.remove());
            
            // Remove any style tags for security
            const styles = tempDiv.querySelectorAll('style');
            styles.forEach(style => style.remove());
            
            // Get text content and clean it up
            let text = tempDiv.textContent || tempDiv.innerText || '';
            text = text.trim();
            
            // Limit length and add ellipsis if needed
            if (text.length > 100) {
                text = text.substring(0, 100) + '...';
            }
            
            return text || '-';
        }
        
        // Get form elements with null checks
        const titleElement = document.getElementById('{{ form.title.id_for_label }}');
        const groupElement = document.getElementById('{{ form.group.id_for_label }}');
        const descriptionElement = document.getElementById('{{ form.description.id_for_label }}');
        const dateElement = document.getElementById('{{ form.date.id_for_label }}');
        const startTimeElement = document.getElementById('{{ form.start_time.id_for_label }}');
        const endTimeElement = document.getElementById('{{ form.end_time.id_for_label }}');
        const addressElement = document.getElementById('{{ form.address.id_for_label }}');
        const cityElement = document.getElementById('{{ form.city.id_for_label }}');
        const stateElement = document.getElementById('id_state');
        const capacityElement = document.getElementById('{{ form.capacity.id_for_label }}');
        const ageRestrictionElement = document.getElementById('{{ form.age_restriction.id_for_label }}');
        const accessibilityElement = document.getElementById('{{ form.accessibility_details.id_for_label }}');
        
        // Get values with safe fallbacks
        const title = titleElement ? titleElement.value || '-' : '-';
        const groupText = groupElement && groupElement.options ? (groupElement.options[groupElement.selectedIndex]?.text || '-') : '-';
        const description = descriptionElement ? descriptionElement.value || '-' : '-';
        const date = dateElement ? dateElement.value || '-' : '-';
        const startTime = startTimeElement ? startTimeElement.value || '-' : '-';
        const endTime = endTimeElement ? endTimeElement.value || '-' : '-';
        const address = addressElement ? addressElement.value || '-' : '-';
        const city = cityElement ? cityElement.value || '-' : '-';
        const state = stateElement ? stateElement.value || '-' : '-';
        const capacity = capacityElement ? capacityElement.value || 'Unlimited' : 'Unlimited';
        const ageText = ageRestrictionElement && ageRestrictionElement.options ? (ageRestrictionElement.options[ageRestrictionElement.selectedIndex]?.text || 'None') : 'None';
        const accessibility = accessibilityElement ? accessibilityElement.value || 'Not specified' : 'Not specified';

        // Update review elements with null checks
        const reviewElements = {
            'review-title': title,
            'review-group': groupText,
            'review-description': safeParseHTML(description),
            'review-date': date,
            'review-time': startTime && endTime && startTime !== '-' && endTime !== '-' ? `${startTime} - ${endTime}` : '-',
            'review-address': address,
            'review-city': city,
            'review-state': state,
            'review-capacity': capacity,
            'review-age': ageText,
            'review-accessibility': safeParseHTML(accessibility)
        };
        
        // Update each review element
        Object.keys(reviewElements).forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = reviewElements[elementId];
            }
        });
        
        console.log('Review summary updated successfully');
    } catch (error) {
        console.error('Error updating review summary:', error);
        // Don't throw the error, just log it
    }
}

// Current Location and Address Autocomplete Functionality
document.addEventListener('DOMContentLoaded', function() {
    const useCurrentLocationBtn = document.getElementById('useCurrentLocation');
    const locationStatus = document.getElementById('locationStatus');
    const addressInput = document.getElementById('{{ form.address.id_for_label }}');
    const cityInput = document.getElementById('{{ form.city.id_for_label }}');
    const stateSelect = document.getElementById('id_state');
    const addressAutocomplete = document.getElementById('addressAutocomplete');
    const addressSuggestions = document.getElementById('addressSuggestions');
    
    let autocompleteTimeout;
    let currentLocation = null;
    
    // Debug field availability
    console.log('Field IDs:', {
        addressFieldId: '{{ form.address.id_for_label }}',
        cityFieldId: '{{ form.city.id_for_label }}',
        addressInput: addressInput,
        cityInput: cityInput
    });

    // Current Location Button
    useCurrentLocationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            return;
        }

        locationStatus.style.display = 'block';
        useCurrentLocationBtn.disabled = true;
        useCurrentLocationBtn.innerHTML = '<i class="material-icons">location_searching</i> Getting location...';

        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Reverse geocode to get address
                reverseGeocode(currentLocation.lat, currentLocation.lng);
            },
            function(error) {
                locationStatus.style.display = 'none';
                useCurrentLocationBtn.disabled = false;
                useCurrentLocationBtn.innerHTML = '<i class="material-icons">my_location</i> Use Current Location';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        alert('Location access denied. Please enable location services.');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert('Location information unavailable.');
                        break;
                    case error.TIMEOUT:
                        alert('Location request timed out.');
                        break;
                    default:
                        alert('An unknown error occurred.');
                        break;
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    });

    // Reverse geocoding function
    function reverseGeocode(lat, lng) {
        console.log('Reverse geocoding for:', lat, lng);
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('Reverse geocoding response:', data);
                if (data.address) {
                    const address = data.address;
                    
                    // Fill in the form fields
                    let addressValue = '';
                    if (address.house_number && address.road) {
                        addressValue = `${address.house_number} ${address.road}`;
                    } else if (address.road) {
                        addressValue = address.road;
                    } else if (address.street) {
                        addressValue = address.street;
                    }
                    
                    if (addressValue) {
                        addressInput.value = addressValue;
                        console.log('Set address to:', addressValue);
                    }
                    
                    let cityValue = '';
                    if (address.city) {
                        cityValue = address.city;
                    } else if (address.town) {
                        cityValue = address.town;
                    } else if (address.village) {
                        cityValue = address.village;
                    } else if (address.county) {
                        cityValue = address.county;
                    }
                    
                    if (cityValue) {
                        cityInput.value = cityValue;
                        console.log('Set city to:', cityValue);
                    }
                    
                    if (address.state) {
                        const stateOption = Array.from(stateSelect.options).find(option => 
                            option.text.toLowerCase() === address.state.toLowerCase()
                        );
                        if (stateOption) {
                            stateSelect.value = stateOption.value;
                            console.log('Set state to:', stateOption.value);
                        }
                    }
                    
                    // Trigger change events to update form validation
                    addressInput.dispatchEvent(new Event('change', { bubbles: true }));
                    cityInput.dispatchEvent(new Event('change', { bubbles: true }));
                    stateSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    locationStatus.style.display = 'none';
                    useCurrentLocationBtn.disabled = false;
                    useCurrentLocationBtn.innerHTML = '<i class="material-icons">my_location</i> Use Current Location';
                    
                    // Show success message
                    showLocationSuccess();
                }
            })
            .catch(error => {
                console.error('Reverse geocoding error:', error);
                locationStatus.style.display = 'none';
                useCurrentLocationBtn.disabled = false;
                useCurrentLocationBtn.innerHTML = '<i class="material-icons">my_location</i> Use Current Location';
                alert('Could not get address from location. Please enter manually.');
            });
    }

    // Show location success message
    function showLocationSuccess() {
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success mt-2';
        successAlert.innerHTML = '<i class="material-icons">check_circle</i> Location filled successfully!';
        locationStatus.appendChild(successAlert);
        
        setTimeout(() => {
            successAlert.remove();
        }, 3000);
    }

    // Address autocomplete functionality
    if (addressInput) {
        addressInput.addEventListener('input', function() {
            clearTimeout(autocompleteTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) {
                addressAutocomplete.style.display = 'none';
                return;
            }

            autocompleteTimeout = setTimeout(() => {
                searchAddresses(query);
            }, 300);
        });
    }

    // Search addresses using OpenStreetMap Nominatim
    function searchAddresses(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayAddressSuggestions(data);
            })
            .catch(error => {
                console.error('Address search error:', error);
            });
    }

    // Display address suggestions
    function displayAddressSuggestions(suggestions) {
        addressSuggestions.innerHTML = '';
        
        if (suggestions.length === 0) {
            addressAutocomplete.style.display = 'none';
            return;
        }

        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            
            const address = suggestion.address;
            const mainText = suggestion.display_name.split(',')[0];
            const secondaryText = suggestion.display_name.split(',').slice(1, 3).join(',');
            
            li.innerHTML = `
                <div class="address-main">${mainText}</div>
                <div class="address-secondary">${secondaryText}</div>
            `;
            
            li.addEventListener('click', function() {
                selectAddress(suggestion);
            });
            
            addressSuggestions.appendChild(li);
        });
        
        addressAutocomplete.style.display = 'block';
    }

    // Select address from autocomplete
    function selectAddress(suggestion) {
        console.log('Selecting address:', suggestion);
        const address = suggestion.address;
        
        // Fill address field
        let addressValue = '';
        if (address.house_number && address.road) {
            addressValue = `${address.house_number} ${address.road}`;
        } else if (address.road) {
            addressValue = address.road;
        } else if (address.street) {
            addressValue = address.street;
        }
        
        if (addressValue) {
            addressInput.value = addressValue;
            console.log('Set address to:', addressValue);
        }
        
        // Fill city field
        let cityValue = '';
        if (address.city) {
            cityValue = address.city;
        } else if (address.town) {
            cityValue = address.town;
        } else if (address.village) {
            cityValue = address.village;
        } else if (address.county) {
            cityValue = address.county;
        }
        
        if (cityValue) {
            cityInput.value = cityValue;
            console.log('Set city to:', cityValue);
        }
        
        // Fill state field
        if (address.state) {
            const stateOption = Array.from(stateSelect.options).find(option => 
                option.text.toLowerCase() === address.state.toLowerCase()
            );
            if (stateOption) {
                stateSelect.value = stateOption.value;
                console.log('Set state to:', stateOption.value);
            }
        }
        
        // Trigger change events to update form validation
        addressInput.dispatchEvent(new Event('change', { bubbles: true }));
        cityInput.dispatchEvent(new Event('change', { bubbles: true }));
        stateSelect.dispatchEvent(new Event('change', { bubbles: true }));
        
        addressAutocomplete.style.display = 'none';
    }

    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!addressInput.contains(e.target) && !addressAutocomplete.contains(e.target)) {
            addressAutocomplete.style.display = 'none';
        }
    });

    // Hide autocomplete on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            addressAutocomplete.style.display = 'none';
        }
    });
    
    // Function to sync visible form fields with hidden ones
    function syncFormFields() {
        console.log('Syncing form fields...');
        
        try {
            // Get visible form fields
            var visibleTitle = document.getElementById('{{ form.title.id_for_label }}');
            var visibleGroup = document.getElementById('{{ form.group.id_for_label }}');
            var visibleDescription = document.getElementById('{{ form.description.id_for_label }}');
            var visibleDate = document.getElementById('{{ form.date.id_for_label }}');
            var visibleStartTime = document.getElementById('{{ form.start_time.id_for_label }}');
            var visibleEndTime = document.getElementById('{{ form.end_time.id_for_label }}');
            var visibleAddress = document.getElementById('{{ form.address.id_for_label }}');
            var visibleCity = document.getElementById('{{ form.city.id_for_label }}');
            var visibleState = document.getElementById('id_state');
            var visibleEulaAgreement = document.getElementById('{{ form.eula_agreement.id_for_label }}');
            var visibleStateAgreement = document.getElementById('{{ form.state_agreement.id_for_label }}');
            
            // Get hidden form fields
            var hiddenTitle = document.querySelector('[name="{{ form.title.name }}"]');
            var hiddenGroup = document.querySelector('[name="{{ form.group.name }}"]');
            var hiddenDescription = document.querySelector('[name="{{ form.description.name }}"]');
            var hiddenDate = document.querySelector('[name="{{ form.date.name }}"]');
            var hiddenStartTime = document.querySelector('[name="{{ form.start_time.name }}"]');
            var hiddenEndTime = document.querySelector('[name="{{ form.end_time.name }}"]');
            var hiddenAddress = document.querySelector('[name="{{ form.address.name }}"]');
            var hiddenCity = document.querySelector('[name="{{ form.city.name }}"]');
            var hiddenEulaAgreement = document.querySelector('[name="{{ form.eula_agreement.name }}"]');
            var hiddenStateAgreement = document.querySelector('[name="{{ form.state_agreement.name }}"]');
            
            console.log('Field elements found:', {
                visibleTitle: !!visibleTitle,
                visibleGroup: !!visibleGroup,
                visibleDescription: !!visibleDescription,
                visibleDate: !!visibleDate,
                visibleStartTime: !!visibleStartTime,
                visibleEndTime: !!visibleEndTime,
                visibleAddress: !!visibleAddress,
                visibleCity: !!visibleCity,
                visibleState: !!visibleState,
                hiddenTitle: !!hiddenTitle,
                hiddenGroup: !!hiddenGroup,
                hiddenDescription: !!hiddenDescription,
                hiddenDate: !!hiddenDate,
                hiddenStartTime: !!hiddenStartTime,
                hiddenEndTime: !!hiddenEndTime,
                hiddenAddress: !!hiddenAddress,
                hiddenCity: !!hiddenCity
            });
            
            // Sync values from visible to hidden fields
            if (visibleTitle && hiddenTitle) {
                hiddenTitle.value = visibleTitle.value;
                console.log('Synced title:', visibleTitle.value);
                console.log('Hidden title value after sync:', hiddenTitle.value);
            } else {
                console.error('Title sync failed:', {
                    visibleTitle: !!visibleTitle,
                    hiddenTitle: !!hiddenTitle,
                    visibleTitleId: visibleTitle ? visibleTitle.id : 'not found',
                    hiddenTitleName: hiddenTitle ? hiddenTitle.name : 'not found'
                });
            }
            
            if (visibleGroup && hiddenGroup) {
                hiddenGroup.value = visibleGroup.value;
                console.log('Synced group:', visibleGroup.value);
            }
            
            if (visibleDescription && hiddenDescription) {
                // For Trix editor, we need to handle attachments and convert them to base64
                const trixEditor = document.querySelector('trix-editor');
                if (trixEditor && trixEditor.editor) {
                    // Get the HTML content from Trix editor
                    let htmlContent = trixEditor.editor.getDocument().toString();
                    
                    // Convert Trix attachments to base64 img tags
                    const attachments = trixEditor.editor.getDocument().getAttachments();
                    for (let i = 0; i < attachments.length; i++) {
                        const attachment = attachments[i];
                        if (attachment.file && attachment.file.type.startsWith('image/')) {
                            // Convert attachment to base64 img tag
                            const imgTag = `<img src="${attachment.url}" alt="${attachment.file.name}" style="max-width: 100%; height: auto;">`;
                            // Replace the attachment placeholder with the img tag
                            htmlContent = htmlContent.replace(attachment.toString(), imgTag);
                        }
                    }
                    
                    hiddenDescription.value = htmlContent;
                    console.log('Synced description with base64 images:', htmlContent);
                } else {
                    // Fallback to direct value sync
                    hiddenDescription.value = visibleDescription.value;
                    console.log('Synced description (fallback):', visibleDescription.value);
                }
            }
            
            if (visibleDate && hiddenDate) {
                hiddenDate.value = visibleDate.value;
                console.log('Synced date:', visibleDate.value);
            }
            
            if (visibleStartTime && hiddenStartTime) {
                hiddenStartTime.value = visibleStartTime.value;
                console.log('Synced start time:', visibleStartTime.value);
            }
            
            if (visibleEndTime && hiddenEndTime) {
                hiddenEndTime.value = visibleEndTime.value;
                console.log('Synced end time:', visibleEndTime.value);
            }
            
            if (visibleAddress && hiddenAddress) {
                hiddenAddress.value = visibleAddress.value;
                console.log('Synced address:', visibleAddress.value);
            }
            
            if (visibleCity && hiddenCity) {
                hiddenCity.value = visibleCity.value;
                console.log('Synced city:', visibleCity.value);
            }
            
            // Sync checkbox fields
            if (visibleEulaAgreement && hiddenEulaAgreement) {
                hiddenEulaAgreement.checked = visibleEulaAgreement.checked;
                console.log('Synced eula agreement:', visibleEulaAgreement.checked);
            }
            
            if (visibleStateAgreement && hiddenStateAgreement) {
                hiddenStateAgreement.checked = visibleStateAgreement.checked;
                console.log('Synced state agreement:', visibleStateAgreement.checked);
            }
            
            console.log('Form field sync completed');
        } catch (error) {
            console.error('Error in syncFormFields:', error);
        }
    }
});
</script>
{% endblock %}