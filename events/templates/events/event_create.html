{% extends 'events/base.html' %}
{% block title %}Create Event - FURsvp{% endblock %}
{% load widget_tweaks %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<style>
/***** Modern Form Styles for Create/Edit Event *****/
.event-section-title {
    font-size: 1.35rem;
    font-weight: 700;
    color: #2563eb;
    margin-bottom: 1.1rem;
    margin-top: 2.2rem;
    display: flex;
    align-items: center;
    gap: 0.5em;
}
.event-section-title:first-child {
    margin-top: 0;
}
.event-form-label {
    font-weight: 600;
    color: #223b7b;
    margin-bottom: 0.3rem;
    display: flex;
    align-items: center;
    gap: 0.4em;
}
.event-form-group {
    margin-bottom: 1.5rem;
}
.event-form-input, .event-form-select, .event-form-textarea {
    border-radius: 0.7rem;
    border: 1.5px solid #c7d7f5;
    font-size: 1.09rem;
    padding: 0.7rem 1.1rem;
    transition: border-color 0.18s, box-shadow 0.18s;
    box-shadow: 0 1px 4px rgba(59,130,246,0.04);
}
.event-form-input:focus, .event-form-select:focus, .event-form-textarea:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px #b3d1f7;
    outline: none;
}
.event-form-icon {
    color: #2563eb;
    font-size: 1.25em;
    margin-right: 0.3em;
}
.dark-mode .modern-breadcrumbs {
    background: linear-gradient(90deg, #22335a 0%, #1a233a 100%) !important;
    color: #e0e7ef !important;
    border-radius: 2rem;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.13);
    border: 1.5px solid #374151;
}
.dark-mode .modern-breadcrumbs .breadcrumb-current,
.dark-mode .modern-breadcrumbs .material-icons {
    color: #60a5fa !important;
}
.dark-mode .modern-breadcrumbs a {
    color: #b3d1f7 !important;
}
/* Match state dropdown to age restriction dropdown */
#id_state.form-select.event-form-input {
    background: linear-gradient(90deg, #f8fafc 0%, #e0e7ef 100%);
    color: #223b7b;
    border-radius: 0.7rem;
    border: 1.5px solid #c7d7f5;
    font-size: 1.09rem;
    padding: 0.7rem 1.1rem;
    transition: border-color 0.18s, box-shadow 0.18s;
    box-shadow: 0 1px 4px rgba(59,130,246,0.04);
}
#id_state.form-select.event-form-input:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px #b3d1f7;
    outline: none;
}
</style>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-4">
                <div class="modern-breadcrumbs">
                    <a href="/" class="d-flex align-items-center">
                        <i class="material-icons me-1">home</i> Events
                    </a>
                    <span class="breadcrumb-chevron">â€º</span>
                    <span class="breadcrumb-current">Create Event</span>
                </div>
            </nav>

            <div class="card shadow-sm border-0" style="border-radius: 1.5rem;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <i class="material-icons text-primary me-2" style="font-size: 2.5rem;">add_circle</i>
                        <h1 class="card-title display-5 mb-0">Create New Event</h1>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Title Field -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">event_note</i>
                                Event Title
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">edit</i>
                                </span>
                                {{ form.title|attr:'placeholder:Event Title' }}
                            </div>
                            {% if form.title.help_text %}
                                <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Group Field -->
                        <div class="mb-4">
                            <label for="{{ form.group.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">groups</i>
                                Group
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">groups</i>
                                </span>
                                {{ form.group|add_class:'event-form-input' }}
                            </div>
                            {% if form.group.help_text %}
                                <div class="form-text">{{ form.group.help_text }}</div>
                            {% endif %}
                            {% if form.group.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.group.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Date/Time Fields -->
                        <div class="mb-4">
                            <label class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">schedule</i>
                                Date and Time
                            </label>
                            <div class="row">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">event</i>
                                    </span>
                                        {{ form.date|attr:'placeholder:Select date' }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">schedule</i>
                                        </span>
                                        {{ form.start_time|attr:'placeholder:Start time'|attr:'required' }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">schedule</i>
                                    </span>
                                        {{ form.end_time|attr:'placeholder:End time'|attr:'required' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Fields -->
                        <div class="mb-4">
                            <label class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">place</i>
                                Location
                                </label>
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">place</i>
                                    </span>
                                    {{ form.address|attr:'placeholder:Street address' }}
                                    <button type="button" id="locationButton"
                                        class="btn btn-outline-primary rounded-end" tabindex="-1">
                                        <i class="material-icons">my_location</i>
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">location_city</i>
                                        </span>
                                        {{ form.city|attr:'placeholder:City' }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">map</i>
                                        </span>
                                        <select name="state" id="id_state" class="form-select" style="height: 48px;">
                                            <option value="">Select State</option>
                                            <option value="Alabama">Alabama</option>
                                            <option value="Alaska">Alaska</option>
                                            <option value="Arizona">Arizona</option>
                                            <option value="Arkansas">Arkansas</option>
                                            <option value="California">California</option>
                                            <option value="Colorado">Colorado</option>
                                            <option value="Connecticut">Connecticut</option>
                                            <option value="Delaware">Delaware</option>
                                            <option value="Florida">Florida</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Hawaii">Hawaii</option>
                                            <option value="Idaho">Idaho</option>
                                            <option value="Illinois">Illinois</option>
                                            <option value="Indiana">Indiana</option>
                                            <option value="Iowa">Iowa</option>
                                            <option value="Kansas">Kansas</option>
                                            <option value="Kentucky">Kentucky</option>
                                            <option value="Louisiana">Louisiana</option>
                                            <option value="Maine">Maine</option>
                                            <option value="Maryland">Maryland</option>
                                            <option value="Massachusetts">Massachusetts</option>
                                            <option value="Michigan">Michigan</option>
                                            <option value="Minnesota">Minnesota</option>
                                            <option value="Mississippi">Mississippi</option>
                                            <option value="Missouri">Missouri</option>
                                            <option value="Montana">Montana</option>
                                            <option value="Nebraska">Nebraska</option>
                                            <option value="Nevada">Nevada</option>
                                            <option value="New Hampshire">New Hampshire</option>
                                            <option value="New Jersey">New Jersey</option>
                                            <option value="New Mexico">New Mexico</option>
                                            <option value="New York">New York</option>
                                            <option value="North Carolina">North Carolina</option>
                                            <option value="North Dakota">North Dakota</option>
                                            <option value="Ohio">Ohio</option>
                                            <option value="Oklahoma">Oklahoma</option>
                                            <option value="Oregon">Oregon</option>
                                            <option value="Pennsylvania">Pennsylvania</option>
                                            <option value="Rhode Island">Rhode Island</option>
                                            <option value="South Carolina">South Carolina</option>
                                            <option value="South Dakota">South Dakota</option>
                                            <option value="Tennessee">Tennessee</option>
                                            <option value="Texas">Texas</option>
                                            <option value="Utah">Utah</option>
                                            <option value="Vermont">Vermont</option>
                                            <option value="Virginia">Virginia</option>
                                            <option value="Washington">Washington</option>
                                            <option value="West Virginia">West Virginia</option>
                                            <option value="Wisconsin">Wisconsin</option>
                                            <option value="Wyoming">Wyoming</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Age Restriction Field -->
                        <div class="mb-4">
                            <label for="{{ form.age_restriction.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">block</i>
                                Age Restriction
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">block</i>
                                </span>
                                {{ form.age_restriction|add_class:'event-form-input' }}
                            </div>
                        </div>

                        <!-- Event Capacity Field -->
                        <div class="mb-4">
                            <label for="{{ form.capacity.id_for_label }}" class="event-form-label">
                                Event Capacity
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">people_alt</i>
                                </span>
                                {{ form.capacity|add_class:'event-form-input'|attr:'placeholder:Enter event capacity (optional)' }}
                            </div>
                            {% if form.capacity.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.capacity.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Waitlist Enabled Field -->
                        <div class="mb-4 event-form-group">
                            <div class="form-check">
                                {{ form.waitlist_enabled }}
                                <label class="form-check-label" for="{{ form.waitlist_enabled.id_for_label }}">
                                    <i class="material-icons align-middle me-1 event-form-icon">queue</i>
                                    Enable Waitlist
                                </label>
                            </div>
                        </div>
                        <!-- Attendee List Public Field -->
                        <div class="mb-4 event-form-group">
                            <div class="form-check">
                                {{ form.attendee_list_public }}
                                <label class="form-check-label" for="{{ form.attendee_list_public.id_for_label }}">
                                    <i class="material-icons align-middle me-1 event-form-icon">visibility</i>
                                    Make attendee list public
                                </label>
                            </div>
                        </div>
                        

                        <!-- Accessibility Field -->
                        <div class="mb-3">
                            <label for="{{ form.accessibility_details.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">accessible</i>
                                Accessibility Details
                            </label>
                            {{ form.accessibility_details }}
                            <small class="form-text text-muted">Leave blank if not accessible.</small>
                        </div>

                        <!-- Enable RSVP Questions Field -->
                        <div id="rsvp-questions-section">
                            <div class="mb-3">
                                <label for="{{ form.question1_text.id_for_label }}" class="form-label"><i class="material-icons align-middle me-1" style="color: #2563eb;">quiz</i> RSVP Question 1</label>
                                {{ form.question1_text }}
                                <div class="form-text">Leave blank to disable this question.</div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.question2_text.id_for_label }}" class="form-label"><i class="material-icons align-middle me-1" style="color: #2563eb;">quiz</i> RSVP Question 2</label>
                                {{ form.question2_text }}
                                <div class="form-text">Leave blank to disable this question.</div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.question3_text.id_for_label }}" class="form-label"><i class="material-icons align-middle me-1" style="color: #2563eb;">quiz</i> RSVP Question 3</label>
                                {{ form.question3_text }}
                                <div class="form-text">Leave blank to disable this question.</div>
                            </div>
                        </div>

                        <!-- Description Field -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="event-form-label">
                                <i class="material-icons align-middle me-1 event-form-icon">description</i>
                                Description
                            </label>
                            {{ form.description }}
                        </div>

                        <!-- Agreement Checkboxes -->
                        <div class="mb-4">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h3 class="h5 fw-bold mb-3">Required Agreements</h3>

                                    <div class="form-check mb-3">
                                        {{ form.eula_agreement }}
                                        <label class="event-form-label" for="{{ form.eula_agreement.id_for_label }}">
                                            {{ form.eula_agreement.label }}
                                            <a href="{% url 'eula' %}" target="_blank" class="ms-1">
                                                <i class="material-icons align-middle"
                                                    style="font-size: 1rem;">open_in_new</i>
                                            </a>
                                        </label>
                                        {% if form.eula_agreement.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.eula_agreement.errors }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="form-check">
                                        {{ form.state_agreement }}
                                        <label class="event-form-label" for="{{ form.state_agreement.id_for_label }}">
                                            {{ form.state_agreement.label }}
                                        </label>
                                        {% if form.state_agreement.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.state_agreement.errors }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            // Toggle accessibility details field
                            const accessibleCheckbox = document.querySelector('input[name="is_accessible"]');
                            const detailsContainer = document.getElementById('accessibility-details-container');
                            function toggleDetails() {
                                if (accessibleCheckbox.checked) {
                                    detailsContainer.style.display = '';
                                } else {
                                    detailsContainer.style.display = 'none';
                                }
                            }
                            if (accessibleCheckbox) {
                                accessibleCheckbox.addEventListener('change', toggleDetails);
                                // Initial state
                                toggleDetails();
                            }
                        </script>

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="material-icons me-2">add</i> Create Event
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                <i class="material-icons me-2">arrow_back</i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize address autocomplete
        const addressInput = document.getElementById('{{ form.address.id_for_label }}');
        const stateInput = document.getElementById('{{ form.state.id_for_label }}');
        const cityInput = document.getElementById('{{ form.city.id_for_label }}');
        let searchTimeout;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second between requests
        let userLocation = null;

        // Get user location when page loads
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                },
                (error) => {
                    console.error('Error getting location:', error);
                }
            );
        }

        // Create autocomplete container
        const autocompleteContainer = document.createElement('div');
        autocompleteContainer.className = 'autocomplete-container';
        autocompleteContainer.style.cssText = `
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 4px;
            top: 100%;
        `;
        addressInput.parentElement.style.position = 'relative';
        addressInput.parentElement.appendChild(autocompleteContainer);

        // Handle address input
        addressInput.addEventListener('input', function (e) {
            e.preventDefault(); // Prevent default to avoid URL showing
            clearTimeout(searchTimeout);
            const query = this.value;

            if (query.length < 3) {
                autocompleteContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                const now = Date.now();
                const timeSinceLastRequest = now - lastRequestTime;

                if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                    setTimeout(() => {
                        performSearch(query);
                    }, MIN_REQUEST_INTERVAL - timeSinceLastRequest);
                } else {
                    performSearch(query);
                }
            }, 300);
        });

        // Prevent form submission on enter
        addressInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Add keyboard navigation
        addressInput.addEventListener('keydown', function (e) {
            const suggestions = autocompleteContainer.getElementsByClassName('autocomplete-suggestion');
            const activeSuggestion = autocompleteContainer.querySelector(
                '.autocomplete-suggestion.active');
            let index = Array.from(suggestions).indexOf(activeSuggestion);

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (index < suggestions.length - 1) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index + 1].classList.add('active');
                        suggestions[index + 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (index > 0) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index - 1].classList.add('active');
                        suggestions[index - 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (activeSuggestion) {
                        activeSuggestion.click();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    autocompleteContainer.style.display = 'none';
                    break;
            }
        });

        function performSearch(query) {
            lastRequestTime = Date.now();

            // Get existing city and state values
            const existingCity = cityInput.value.trim();
            const existingState = stateInput.value.trim();

            // Build the search query
            let searchQuery = query;
            if (existingCity && existingState) {
                searchQuery = `${query} ${existingCity} ${existingState}`;
            }

            let searchUrl =
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=us&addressdetails=1&limit=10`;

            // If we have user location, add it to the search to prioritize nearby results
            if (userLocation) {
                searchUrl += `&lat=${userLocation.lat}&lon=${userLocation.lon}&radius=50000`; // 50km radius
            }

            fetch(searchUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'FURsvp/1.0 (https://fursvp.org)',
                        'Referer': window.location.origin
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Geocoding API error:', response.status, response.statusText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    console.log('Search query that failed:', searchQuery);
                    autocompleteContainer.style.display = 'none';
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        autocompleteContainer.style.display = 'none';
                        return;
                    }

                    // Clear existing suggestions
                    autocompleteContainer.innerHTML = '';

                    // Add new suggestions
                    data.forEach(result => {
                        const address = result.address;
                        let streetAddress = '';
                        let fullAddress = '';

                        if (address.road) {
                            streetAddress = address.road;
                            fullAddress = address.road;
                            if (address.house_number) {
                                streetAddress = address.house_number + ' ' + streetAddress;
                                fullAddress = address.house_number + ' ' + fullAddress;
                            }
                            // Add city and state to the full address only
                            if (address.city || address.town || address.village) {
                                fullAddress += ', ' + (address.city || address.town ||
                                    address.village);
                            }
                            if (address.state) {
                                fullAddress += ', ' + address.state;
                            }
                        }

                        if (streetAddress) {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'autocomplete-suggestion';
                            suggestion.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                    `;
                            suggestion.textContent = fullAddress;
                            suggestion.addEventListener('click', () => {
                                // Set only the street address in the address field
                                addressInput.value = streetAddress;
                                // Update city and state fields separately
                                if (address.state) {
                                    stateInput.value = address.state;
                                }
                                if (address.city || address.town || address.village) {
                                    cityInput.value = address.city || address.town ||
                                        address.village;
                                }
                                autocompleteContainer.style.display = 'none';
                            });
                            suggestion.addEventListener('mouseover', () => {
                                // Remove active class from all suggestions
                                Array.from(autocompleteContainer.getElementsByClassName(
                                    'autocomplete-suggestion')).forEach(s => {
                                    s.classList.remove('active');
                                });
                                suggestion.classList.add('active');
                                suggestion.style.backgroundColor = '#f5f5f5';
                            });
                            suggestion.addEventListener('mouseout', () => {
                                suggestion.style.backgroundColor = 'white';
                            });
                            autocompleteContainer.appendChild(suggestion);
                        }
                    });

                    // Add active class to first suggestion
                    const firstSuggestion = autocompleteContainer.querySelector('.autocomplete-suggestion');
                    if (firstSuggestion) {
                        firstSuggestion.classList.add('active');
                    }

                    autocompleteContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching address:', error);
                    autocompleteContainer.style.display = 'none';
                });
        }

        // Handle location button click
        const locationButton = document.getElementById('locationButton');
        locationButton.addEventListener('click', (e) => {
            e.preventDefault();

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            locationButton.disabled = true;
            locationButton.innerHTML = '<i class="material-icons">hourglass_empty</i>';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        // Search for nearby cities instead of exact location
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&addressdetails=1&zoom=10`, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'User-Agent': 'FURsvp/1.0 (https://fursvp.org)',
                                    'Referer': window.location.origin
                                }
                            }
                        );

                        if (!response.ok) {
                            console.error('Reverse geocoding API error:', response.status, response.statusText);
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        if (data && data.address) {
                            // Create a container for nearby cities
                            const nearbyContainer = document.createElement('div');
                            nearbyContainer.className = 'autocomplete-container';
                            nearbyContainer.style.cssText = `
                        position: absolute;
                        width: 100%;
                        max-height: 200px;
                        overflow-y: auto;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        z-index: 1000;
                        margin-top: 4px;
                    `;
                            addressInput.parentElement.appendChild(nearbyContainer);

                            // Add the current location as a suggestion
                            const suggestion = document.createElement('div');
                            suggestion.className = 'autocomplete-suggestion';
                            suggestion.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                    `;
                            suggestion.textContent = data.display_name;
                            suggestion.addEventListener('click', () => {
                                // Set city and state only (ignore county)
                                if (data.address) {
                                    if (data.address.city || data.address.town || data.address.village) {
                                        cityInput.value = data.address.city || data.address.town || data.address.village;
                                    }
                                    if (data.address.state) {
                                        // Set the state dropdown by matching the state name
                                        for (let i = 0; i < stateInput.options.length; i++) {
                                            if (stateInput.options[i].text === data.address.state) {
                                                stateInput.selectedIndex = i;
                                                stateInput.dispatchEvent(new Event('change'));
                                                break;
                                            }
                                        }
                                    }
                                }
                                nearbyContainer.remove();
                            });
                            suggestion.addEventListener('mouseover', () => {
                                suggestion.style.backgroundColor = '#f5f5f5';
                            });
                            suggestion.addEventListener('mouseout', () => {
                                suggestion.style.backgroundColor = 'white';
                            });
                            nearbyContainer.appendChild(suggestion);

                            // Close suggestions when clicking outside
                            document.addEventListener('click', function closeSuggestions(e) {
                                if (!nearbyContainer.contains(e.target) && e.target !==
                                    locationButton) {
                                    nearbyContainer.remove();
                                    document.removeEventListener('click',
                                        closeSuggestions);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching nearby cities:', error);
                        alert('Error getting nearby cities. Please try again.');
                    } finally {
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert(
                        'Error getting your location. Please make sure location services are enabled.'
                        );
                    locationButton.disabled = false;
                    locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                }
        );
    });

    // Initialize Quill.js
    function initQuill() {
        const isDark = document.body.classList.contains('dark-mode');
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        
        if (!descriptionField) return;
        
        // Create Quill container
        const quillContainer = document.createElement('div');
        quillContainer.id = 'quill-editor';
        quillContainer.style.height = '300px';
        descriptionField.parentNode.insertBefore(quillContainer, descriptionField);
        descriptionField.style.display = 'none';
        
        // Initialize Quill
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Describe your event...',
            readOnly: false
        });
        
        // Set initial content if any
        if (descriptionField.value) {
            quill.root.innerHTML = descriptionField.value;
        }
        
        // Sync Quill content with hidden textarea
        quill.on('text-change', function() {
            descriptionField.value = quill.root.innerHTML;
        });
        
        // Dark mode support
        if (isDark) {
            quillContainer.querySelector('.ql-toolbar').style.backgroundColor = '#2d3748';
            quillContainer.querySelector('.ql-toolbar').style.borderColor = '#4a5568';
            quillContainer.querySelector('.ql-container').style.backgroundColor = '#2d3748';
            quillContainer.querySelector('.ql-container').style.borderColor = '#4a5568';
            quillContainer.querySelector('.ql-editor').style.color = '#e2e8f0';
        }
    }

    // Initialize Quill on page load
    initQuill();

    // Initialize Flatpickr
    flatpickr("#{{ form.date.id_for_label }}", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: "true",
            theme: "light",
        allowInput: true,
        altInput: true,
        altFormat: "F j, Y",
        altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
            document.getElementById("{{ form.date.id_for_label }}").value = dateStr;
            },
            onReady: function (selectedDates, dateStr, instance) {
                // Add custom styles to match theme
                const calendar = instance.calendarContainer;
                calendar.style.borderRadius = '8px';
                calendar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                calendar.style.border = '1px solid #dee2e6';

                // Style the selected date
                const selectedDay = calendar.querySelector('.selected');
                if (selectedDay) {
                    selectedDay.style.backgroundColor = '#0d6efd';
                    selectedDay.style.borderColor = '#0d6efd';
                }

                // Style the current day
                const today = calendar.querySelector('.today');
                if (today) {
                    today.style.borderColor = '#0d6efd';
                }
            }
        });

        // Initialize Flatpickr for start_time
        const startTimePicker = flatpickr("#{{ form.start_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.start_time.id_for_label }}").value = dateStr;
                // Update end time min time when start time changes
                if (endTimePicker) {
                    endTimePicker.set('minTime', dateStr);
                    // If end time is before start time, update it
                    const endTime = endTimePicker.selectedDates[0];
                    if (endTime && endTime < selectedDates[0]) {
                        endTimePicker.setDate(selectedDates[0]);
                    }
                }
            }
        });

        // Initialize Flatpickr for end_time
        const endTimePicker = flatpickr("#{{ form.end_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.end_time.id_for_label }}").value = dateStr;
        }
    });

    // RSVP Questions toggle
    var enableRsvpQuestions = document.getElementById('{{ form.enable_rsvp_questions.id_for_label }}');
    var rsvpQuestionsSection = document.getElementById('rsvp-questions-section');
    if (enableRsvpQuestions && rsvpQuestionsSection) {
        enableRsvpQuestions.addEventListener('change', function() {
            rsvpQuestionsSection.style.display = this.checked ? 'block' : 'none';
        });
    }
});
</script>
{% endblock %}