<!-- Trix Editor Component -->
<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css">
<script type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>

<style>
/* Trix Editor Styling */
trix-editor {
    border-radius: 0 0 12px 12px !important;
    border: 2px solid #e2e8f0 !important;
    border-top: none !important;
    background: white !important;
    min-height: 200px !important;
    padding: 1.5rem !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    margin-top: -20px !important;
    position: relative !important;
    z-index: 1 !important;
}

trix-toolbar {
    border-radius: 12px 12px 0 0 !important;
    border: 2px solid #e2e8f0 !important;
    border-bottom: none !important;
    background: #f8fafc !important;
    padding: 0.75rem !important;
    transform: scale(0.85) !important;
    transform-origin: top left !important;
    width: 117.65% !important;
    margin-bottom: 0 !important;
    position: relative !important;
    z-index: 2 !important;
}

trix-toolbar .trix-button {
    border: none !important;
    background: transparent !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    font-size: 1rem !important;
}

trix-toolbar .trix-button:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button.trix-active {
    background: #4f46e5 !important;
    color: white !important;
}

trix-toolbar .trix-button.trix-active:hover {
    background: #4338ca !important;
}

/* Custom attachment button styling */
trix-toolbar .trix-button--icon-attach {
    background: transparent !important;
    border: none !important;
    color: #64748b !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 8px !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
}

trix-toolbar .trix-button--icon-attach:hover {
    background: #e2e8f0 !important;
    color: #374151 !important;
}

trix-toolbar .trix-button--icon-attach .trix-button-icon {
    font-size: 1rem !important;
    line-height: 1 !important;
}

/* Ensure bold and italic button icons are visible */
trix-toolbar .trix-button--icon-bold .trix-button-icon,
trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-weight: bold !important;
    font-size: 1rem !important;
    line-height: 1 !important;
    color: #64748b !important;
    display: block !important;
}

trix-toolbar .trix-button--icon-bold .trix-button-icon {
    font-family: serif !important;
}

trix-toolbar .trix-button--icon-italic .trix-button-icon {
    font-style: italic !important;
    font-family: serif !important;
}

/* Fix divider and corner issues */
trix-toolbar .trix-button-group {
    border: none !important;
    margin-right: 0.75rem !important;
}

trix-toolbar .trix-button-group:not(:last-child) {
    border-right: 1px solid #e2e8f0 !important;
    padding-right: 0.75rem !important;
}

/* Ensure proper border radius and no gaps */
trix-toolbar {
    overflow: hidden !important;
}

/* Container styling to eliminate gaps */
trix-editor {
    display: block !important;
}

/* Override any default margins/padding that might cause gaps */
trix-editor:before,
trix-editor:after {
    display: none !important;
}

/* Attachment preview styling */
trix-editor .trix-attachment {
    border-radius: 8px !important;
    border: 1px solid #e2e8f0 !important;
    margin: 0.5rem 0 !important;
    padding: 0.5rem !important;
    background: #f8fafc !important;
}

trix-editor .trix-attachment__caption {
    color: #64748b !important;
    font-size: 0.875rem !important;
    margin-top: 0.25rem !important;
}
</style>

<script>
class TrixEditorComponent {
    constructor(containerId, options = {}) {
        this.containerId = containerId;
        this.options = {
            placeholder: 'Start typing...',
            minHeight: '200px',
            maxFileSize: 5 * 1024 * 1024, // 5MB
            acceptedFileTypes: [
                'image/*',
                'application/pdf',
                'text/plain',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ],
            ...options
        };
        
        this.init();
    }
    
    init() {
        // Configure Trix for file attachments
        if (typeof Trix !== 'undefined') {
            // Allow file attachments (images, documents, etc.)
            Trix.config.attachments.preview.caption = {
                name: false,
                size: false
            };
            
            // Configure accepted file types
            Trix.config.attachments.accept = this.options.acceptedFileTypes;
            
            // Set maximum file size
            Trix.config.attachments.maxFileSize = this.options.maxFileSize;
            
            // Initialize the editor
            this.setupEditor();
        } else {
            console.error('Trix not loaded');
        }
    }
    
    setupEditor() {
        document.addEventListener('trix-initialize', (event) => {
            if (event.target.closest(`#${this.containerId}`)) {
                this.customizeToolbar(event.target);
            }
        });
    }
    
    customizeToolbar(editor) {
        const toolbar = editor.toolbarElement;
        
        // Remove unnecessary buttons
        const buttonsToRemove = [
            '[data-trix-attribute="href"]', // Link button
            '[data-trix-attribute="quote"]', // Quote button
            '[data-trix-attribute="code"]', // Code button
            '[data-trix-action="outdent"]', // Outdent button
            '[data-trix-action="indent"]'   // Indent button
        ];
        
        buttonsToRemove.forEach(selector => {
            const button = toolbar.querySelector(selector);
            if (button) {
                button.remove();
            }
        });
        
        // Remove any existing attachment buttons to avoid duplicates
        const existingAttachButtons = toolbar.querySelectorAll('[data-trix-action="attachFiles"]');
        existingAttachButtons.forEach(button => {
            button.remove();
        });
        
        // Create image button
        const imageButton = this.createImageButton(editor);
        
        // Reorder toolbar with logical grouping
        this.reorderToolbar(toolbar, imageButton);
        
        // Add event handlers
        this.addEventHandlers(editor);
    }
    
    createImageButton(editor) {
        const imageButton = document.createElement('button');
        imageButton.type = 'button';
        imageButton.className = 'trix-button trix-button--icon trix-button--icon-attach';
        imageButton.setAttribute('data-trix-attribute', 'href');
        imageButton.setAttribute('data-trix-action', 'attachFiles');
        imageButton.title = 'Insert images and files';
        imageButton.innerHTML = '<span class="trix-button-icon">üñºÔ∏è</span>';
        
        // Create file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.accept = this.options.acceptedFileTypes.join(',');
        fileInput.style.display = 'none';
        
        // Add click handler
        imageButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const attachment = new Trix.Attachment({
                        file: file,
                        url: e.target.result
                    });
                    editor.insertAttachment(attachment);
                };
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        });
        
        // Add the file input to the document
        document.body.appendChild(fileInput);
        
        return imageButton;
    }
    
    reorderToolbar(toolbar, imageButton) {
        const buttonGroups = toolbar.querySelectorAll('.trix-button-group');
        if (buttonGroups.length >= 2) {
            const firstGroup = buttonGroups[0];
            const secondGroup = buttonGroups[1];
            
            // Clear first group and add text formatting buttons first
            firstGroup.innerHTML = '';
            
            // Add text formatting buttons to first group
            const boldButton = toolbar.querySelector('[data-trix-attribute="bold"]');
            const italicButton = toolbar.querySelector('[data-trix-attribute="italic"]');
            
            // Create bold button if it doesn't exist
            if (!boldButton) {
                const newBoldButton = this.createFormatButton('bold', 'B', 'Bold');
                firstGroup.appendChild(newBoldButton);
            } else {
                firstGroup.appendChild(boldButton);
            }
            
            // Create italic button if it doesn't exist
            if (!italicButton) {
                const newItalicButton = this.createFormatButton('italic', 'I', 'Italic');
                firstGroup.appendChild(newItalicButton);
            } else {
                firstGroup.appendChild(italicButton);
            }
            
            // Add image button as the 3rd item
            firstGroup.appendChild(imageButton);
            
            // Add list buttons to second group
            const bulletListButton = toolbar.querySelector('[data-trix-attribute="bullet"]');
            const numberListButton = toolbar.querySelector('[data-trix-attribute="number"]');
            
            if (bulletListButton) secondGroup.appendChild(bulletListButton);
            if (numberListButton) secondGroup.appendChild(numberListButton);
            
            // Move undo/redo to the second group (after the numbered list)
            const undoButton = toolbar.querySelector('[data-trix-action="undo"]');
            const redoButton = toolbar.querySelector('[data-trix-action="redo"]');
            
            if (undoButton) secondGroup.appendChild(undoButton);
            if (redoButton) secondGroup.appendChild(redoButton);
        }
    }
    
    createFormatButton(attribute, text, title) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `trix-button trix-button--icon trix-button--icon-${attribute}`;
        button.setAttribute('data-trix-attribute', attribute);
        button.setAttribute('data-trix-key', text.toLowerCase());
        button.title = title;
        button.innerHTML = `<span class="trix-button-icon">${text}</span>`;
        return button;
    }
    
    addEventHandlers(editor) {
        // Add event handlers for formatting buttons
        const formatButtons = editor.toolbarElement.querySelectorAll('[data-trix-attribute]');
        formatButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const attribute = button.getAttribute('data-trix-attribute');
                
                if (attribute === 'bold') {
                    editor.activateAttribute('bold');
                } else if (attribute === 'italic') {
                    editor.activateAttribute('italic');
                }
            });
        });
    }
    
    // Public methods
    getContent() {
        const editor = document.querySelector(`#${this.containerId} trix-editor`);
        return editor ? editor.value : '';
    }
    
    setContent(content) {
        const editor = document.querySelector(`#${this.containerId} trix-editor`);
        if (editor) {
            editor.value = content;
        }
    }
    
    focus() {
        const editor = document.querySelector(`#${this.containerId} trix-editor`);
        if (editor) {
            editor.focus();
        }
    }
}

// Auto-initialize if data-trix-editor attribute is present
document.addEventListener('DOMContentLoaded', () => {
    const trixContainers = document.querySelectorAll('[data-trix-editor]');
    trixContainers.forEach(container => {
        const containerId = container.id;
        const options = {
            placeholder: container.getAttribute('data-placeholder') || 'Start typing...',
            minHeight: container.getAttribute('data-min-height') || '200px',
            maxFileSize: parseInt(container.getAttribute('data-max-file-size')) || 5 * 1024 * 1024,
            acceptedFileTypes: container.getAttribute('data-accepted-types')?.split(',') || [
                'image/*',
                'application/pdf',
                'text/plain',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ]
        };
        
        new TrixEditorComponent(containerId, options);
    });
});
</script>